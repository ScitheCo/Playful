---------------- FILE: ProjectileController.cs ----------------
using UnityEngine;

public class ProjectileController : MonoBehaviour
{
    private float damageAmount;
    private bool isEnemyAttack; // True = Player'a vuruyor, False = Rakibe
    private Vector3 targetPosition;
    
    [Header("Ayarlar")]
    public float speed = 1500f; 
    public float hitThreshold = 10f; 

    // --- YENİ: VFX REFERANSI ---
    [Header("Görsel Efektler")]
    public GameObject hitEffectPrefab; // Çarpma anında çıkacak efekt
    // ---------------------------

    public void Initialize(float damage, bool isEnemy, Vector3 target)
    {
        damageAmount = damage;
        isEnemyAttack = isEnemy;
        targetPosition = target;
        
        // Yönü hedefe çevir
        Vector3 dir = targetPosition - transform.position;
        float angle = Mathf.Atan2(dir.y, dir.x) * Mathf.Rad2Deg;
        transform.rotation = Quaternion.AngleAxis(angle, Vector3.forward);
    }

    void Update()
    {
        float step = speed * Time.deltaTime;
        transform.position = Vector3.MoveTowards(transform.position, targetPosition, step);

        if (Vector3.Distance(transform.position, targetPosition) < hitThreshold)
        {
            OnHit();
        }
    }

    void OnHit()
    {
        // 1. Hasarı İşle
        if (BattleManager.Instance != null)
        {
            BattleManager.Instance.TakeDamage(isEnemyAttack, damageAmount);
        }

        // 2. Çarpma Efekti Yarat
        if (hitEffectPrefab != null)
        {
            GameObject vfx = Instantiate(hitEffectPrefab, transform.position, Quaternion.identity);
            
            // Efekti UI içinde tut
            vfx.transform.SetParent(transform.parent); 
            vfx.transform.localScale = Vector3.one;

            Destroy(vfx, 2f); 
        }

        // 3. Mermiyi Yok Et
        Destroy(gameObject);
    }
}


---------------- FILE: TileController.cs ----------------
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;
using System.Collections;

public class TileController : MonoBehaviour, IPointerDownHandler, IPointerUpHandler
{
    public int x;
    public int y;
    public int typeID;

    private Image myImage;
    private RectTransform rectTransform;
    private BoardManager board;

    // Hareket Ayarları
    private bool isMoving = false;
    private float moveSpeed = 0.2f;

    // Swipe Ayarları
    private float swipeThreshold = 30f; 
    private Vector2 startTouchPosition;
    private Vector2 endTouchPosition;

    // --- YENİ: VFX REFERANSI ---
    [Header("Görsel Efektler")]
    public GameObject explosionPrefab; // Inspector'dan patlama efektini buraya sürükle
    // ---------------------------

    private void Awake()
    {
        myImage = GetComponent<Image>();
        rectTransform = GetComponent<RectTransform>();
    }

    public void Initialize(int _x, int _y, int _type, Sprite _sprite, BoardManager _board)
    {
        x = _x;
        y = _y;
        typeID = _type;
        myImage.sprite = _sprite;
        board = _board;
        name = $"Tile_{x}_{y}";
    }

    public void MoveToPosition(Vector2 targetPosition)
    {
        StartCoroutine(MoveCoroutine(targetPosition));
    }

    IEnumerator MoveCoroutine(Vector2 targetPosition)
    {
        isMoving = true;
        Vector2 startPosition = rectTransform.anchoredPosition;
        float elapsed = 0f;

        while (elapsed < moveSpeed)
        {
            rectTransform.anchoredPosition = Vector2.Lerp(startPosition, targetPosition, elapsed / moveSpeed);
            elapsed += Time.deltaTime;
            yield return null;
        }

        rectTransform.anchoredPosition = targetPosition;
        isMoving = false;
    }

    // === GÜNCELLENEN PATLAMA FONKSİYONU ===
    public void Explode()
    {
        // 1. Efekt Yarat
        if (explosionPrefab != null)
        {
            // Efekti taşın olduğu yerde yarat
            GameObject vfx = Instantiate(explosionPrefab, transform.position, Quaternion.identity);
            
            // Efekt UI içinde düzgün gözüksün diye taşın parent'ına (BoardPanel) bağla
            vfx.transform.SetParent(transform.parent);
            vfx.transform.localScale = Vector3.one; 
            
            // Efekti 2 saniye sonra temizle
            Destroy(vfx, 2f);
        }

        // 2. Küçülerek Yok Ol
        StartCoroutine(ExplodeCoroutine());
    }

    IEnumerator ExplodeCoroutine()
    {
        float elapsed = 0f;
        float duration = 0.2f;
        Vector3 startScale = transform.localScale;

        while (elapsed < duration)
        {
            transform.localScale = Vector3.Lerp(startScale, Vector3.zero, elapsed / duration);
            elapsed += Time.deltaTime;
            yield return null;
        }
        Destroy(gameObject);
    }

    // === INPUT ===
    public void OnPointerDown(PointerEventData eventData)
    {
        if (isMoving || board.IsBoardLocked()) return;
        startTouchPosition = eventData.position;
    }

    public void OnPointerUp(PointerEventData eventData)
    {
        if (isMoving || board.IsBoardLocked()) return;
        endTouchPosition = eventData.position;
        CalculateSwipe();
    }

    void CalculateSwipe()
    {
        Vector2 swipeVector = endTouchPosition - startTouchPosition;
        if (swipeVector.magnitude < swipeThreshold) return;

        swipeVector.Normalize();

        if (Mathf.Abs(swipeVector.x) > Mathf.Abs(swipeVector.y))
        {
            if (swipeVector.x > 0) board.AttemptSwap(x, y, 1, 0); 
            else board.AttemptSwap(x, y, -1, 0); 
        }
        else
        {
            if (swipeVector.y > 0) board.AttemptSwap(x, y, 0, 1); 
            else board.AttemptSwap(x, y, 0, -1); 
        }
    }
}


---------------- FILE: CharacterData.cs ----------------
using UnityEngine;

[CreateAssetMenu(fileName = "NewCharacter", menuName = "Playful/Character Data")]
public class CharacterData : ScriptableObject
{
    [Header("Kimlik")]
    public string characterName;
    public Sprite avatar; 
    public string className; 

    [Header("Ekonomi (YENİ)")]
    public bool isDefaultUnlocked = false; // Oyun başı açık mı? (Örn: Warrior true, diğerleri false)
    public int goldPrice = 1000; // Emekle alma fiyatı
    public int gemPrice = 100;   // Parayla alma fiyatı

    [Header("Temel İstatistikler")]
    public float maxHealth = 1000f;
    public float maxMana = 100f;

    [Header("Savaş Ayarları")]
    public float baseAttackDamage = 15f; 
    public float attackSpeedMultiplier = 1.0f;

    [Header("Yetenekler")]
    public SkillData activeSkill; 
    
    [Header("Pasif Çarpanlar")]
    public float redDamageMultiplier = 1.0f;
    public float blueManaMultiplier = 1.0f;
    public float greenHealMultiplier = 1.0f;
}


---------------- FILE: GameEnums.cs ----------------
// Oyun Modları
public enum GameMode
{
    Practice,   // Botlara karşı alıştırma (Elo değişmez)
    Casual,     // İnsanlara karşı eğlence (Elo değişmez, ödül az)
    Ranked,     // Rekabetçi (Elo değişir, ödül çok)
    FriendMatch // Arkadaşla özel oda (Elo değişmez)
}


---------------- FILE: LevelData.cs ----------------
using UnityEngine;
using System.Collections.Generic;

// Sağ tık menüsüne "Create Level" ekler
[CreateAssetMenu(fileName = "NewLevel", menuName = "Playful/Level Data")]
public class LevelData : ScriptableObject
{
    public int width = 7;
    public int height = 8;

    // Tek boyutlu dizi (Inspector'da serileştirmesi kolaydır)
    // true = Oynanabilir Alan, false = Ölü Alan (Duvar)
    [HideInInspector] 
    public bool[] activeSlots; 

    // Veriyi güvenli şekilde başlatma
    public void Initialize()
    {
        if (activeSlots == null || activeSlots.Length != width * height)
        {
            activeSlots = new bool[width * height];
            for (int i = 0; i < activeSlots.Length; i++) activeSlots[i] = true; // Hepsi açık başlasın
        }
    }
}


---------------- FILE: PlayerData.cs ----------------
using System.Collections.Generic;

[System.Serializable]
public class PlayerData
{
    public string username = "NewPlayer";
    
    public int avatarId = 0; // Seçili avatarın ID'si (List sırası)
    public int frameId = 0;  // Seçili çerçevenin ID'si
    
    // Ekonomi
    public int gold = 1000;
    public int gems = 10;
    
    // Ayarlar
    public float musicVolume = 1.0f;
    public float sfxVolume = 1.0f;
    
    // İlerleme
    public int elo = 1200;
    public int level = 1;
    public float currentXP = 0;
    public float requiredXP = 100;
    
    // Karakterler
    public List<string> unlockedCharacters = new List<string>() { "Warrior" }; // Varsayılan açık karakter
    public string lastSelectedCharacterName = "Warrior"; // Varsayılan seçili

    public PlayerData()
    {
        // Constructor: İlk açılış değerleri
        username = "NewPlayer";
        gold = 1000;
        gems = 10;
        elo = 1200;
        level = 1;
        unlockedCharacters = new List<string>() { "Warrior" };
        lastSelectedCharacterName = unlockedCharacters[0];
    }
}


---------------- FILE: RankData.cs ----------------
using UnityEngine;
using System.Collections.Generic;

[CreateAssetMenu(fileName = "NewRankData", menuName = "Playful/Rank Data")]
public class RankData : ScriptableObject
{
    [System.Serializable]
    public struct RankTier
    {
        public string rankName;  // Bronze, Silver...
        public int minElo;       // 0, 1200, 1500...
        public Sprite rankIcon;  // Rütbe ikonu
    }

    public List<RankTier> ranks;

    // Elo puanına göre hangi rütbede olduğunu bulur
    public RankTier GetRankByElo(int elo)
    {
        // En yüksek puandan aşağı doğru tara
        for (int i = ranks.Count - 1; i >= 0; i--)
        {
            if (elo >= ranks[i].minElo)
                return ranks[i];
        }
        return ranks[0]; // Hiçbiri uymazsa en düşük rütbe
    }

    // Bir sonraki rütbeyi bulur (Slider hesaplamak için)
    public RankTier GetNextRank(int elo)
    {
        for (int i = 0; i < ranks.Count; i++)
        {
            if (ranks[i].minElo > elo)
                return ranks[i];
        }
        return ranks[ranks.Count - 1]; // Zaten son rütbedeyse aynısını dön
    }
}


---------------- FILE: SkillData.cs ----------------
using UnityEngine;

// Abstract: Tek başına kullanılamaz, türetilmesi gerekir.
public abstract class SkillData : ScriptableObject
{
    public string skillName;
    public Sprite skillIcon;
    public int manaCost = 100;
    [TextArea] public string description;

    // Her yetenek bu fonksiyonu kendi bildiği gibi dolduracak
    public abstract void Trigger(BattleManager battleManager, EnemyManager enemyManager, bool isPlayer);
}


---------------- FILE: BattleManager.cs ----------------
using UnityEngine;
using System.Collections.Generic;
using FishNet;
using FishNet.Connection;
using FishNet.Transporting;

public class BattleManager : MonoBehaviour
{
    public static BattleManager Instance;

    [Header("Karakter Seçimi")]
    public CharacterData playerProfile; 
    public CharacterData enemyProfile; 

    [Header("Canlı Veriler (Sadece Gösterge)")]
    public float currentPlayerHealth;
    public float currentEnemyHealth;
    public float currentMana = 0;
    
    private bool opponentDisconnected = false;
    
    [Header("Network Referansları")]
    public NetworkPlayerController localNetworkPlayer;
    public NetworkPlayerController remoteNetworkPlayer;

    private float playerMaxHP;
    private float enemyMaxHP;
    private float playerMaxMana;
    private bool isPlayerShieldActive = false;
    private float shieldDuration = 0f;
    public float roundTime = 120f;
    private bool isGameActive = true;

    [HideInInspector] public float totalDamageDealt = 0;
    [HideInInspector] public float matchDurationCounter = 0;
    [HideInInspector] public int maxCombo = 0;

    private void Awake() { Instance = this; }

    void Start()
    {
        // 1. Verileri Yükle
        if (GameManager.Instance.currentEnemyCharacter != null) enemyProfile = GameManager.Instance.currentEnemyCharacter;
        if (GameManager.Instance.selectedCharacter != null) playerProfile = GameManager.Instance.selectedCharacter;

        InitializeCharacters();
        
        // --- GÖRSEL YÜKLEME (Avatar/Çerçeve) ---
        var ui = UIManager.Instance?.GetPanel<BattleUI>();
        if (ui != null)
        {
            // Bizim Veriler
            Sprite myAv = GameManager.Instance.GetAvatarSprite(GameManager.Instance.playerData.avatarId);
            Sprite myFr = GameManager.Instance.GetFrameSprite(GameManager.Instance.playerData.frameId);
            
            // Rakip Veriler (GameManager'dan gelir)
            Sprite enAv = GameManager.Instance.GetAvatarSprite(GameManager.Instance.currentEnemyAvatarId);
            Sprite enFr = GameManager.Instance.GetFrameSprite(GameManager.Instance.currentEnemyFrameId);
            
            ui.SetAvatars(myAv, myFr, enAv, enFr);
        }
        // ----------------------------------------

        // Network Güvenlik Ağı
        NetworkPlayerController[] players = FindObjectsOfType<NetworkPlayerController>();
        foreach(var p in players)
        {
            if (p.IsOwner) RegisterNetworkPlayer(p, true);
            else RegisterNetworkPlayer(p, false);
        }

        UpdateAllUI();
        
        // --- DISCONNECT DİNLEME ---
        // Sadece Online maçlarda dinle
        bool isRealOnlineMatch = (GameManager.Instance.currentMode != GameMode.Practice) && !GameManager.Instance.isFakeBotMatch;
        if (isRealOnlineMatch && InstanceFinder.NetworkManager != null)
        {
            // ServerManager: Sunucu tarafında bir client koptuğunda çalışır
            // ClientManager: Bizim bağlantımız koptuğunda çalışır
            InstanceFinder.NetworkManager.ServerManager.OnRemoteConnectionState += OnRemoteConnectionState;
        }
    }
    
    private void OnDestroy()
    {
        // Event aboneliğini temizle
        if (InstanceFinder.NetworkManager != null)
        {
            InstanceFinder.NetworkManager.ServerManager.OnRemoteConnectionState -= OnRemoteConnectionState;
        }
    }

    // --- RAKİP AYRILDI MI? ---
    private void OnRemoteConnectionState(NetworkConnection conn, RemoteConnectionStateArgs args)
    {
        // Eğer bağlantı durumu 'Stopped' olduysa biri koptu demektir.
        if (args.ConnectionState == RemoteConnectionState.Stopped)
        {
            Debug.LogWarning($"Bir oyuncu koptu! ID: {conn.ClientId}");
            
            // Eğer oyun hala devam ediyorsa
            if (isGameActive && !opponentDisconnected)
            {
                opponentDisconnected = true;
                HandleOpponentDisconnect();
            }
        }
    }

    private void HandleOpponentDisconnect()
    {
        Debug.Log("RAKİP OYUNDAN AYRILDI! HÜKMEN GALİBİYET.");
        
        // UI'da mesaj göster (İstersen özel bir panel açabilirsin)
        // Şimdilik direkt kazanma ekranına atıyoruz
        
        // Rakibin canını 0 yap
        currentEnemyHealth = 0;
        
        // Oyunu bitir ve kazanma verisi gönder
        EndGame(true); // true = Rakip kaçtığı için özel mesaj gösterebilirsin EndGameManager'da
    }

    void InitializeCharacters()
    {
        if (playerProfile != null) { playerMaxHP = playerProfile.maxHealth; playerMaxMana = playerProfile.maxMana; }
        else { playerMaxHP = 1000; playerMaxMana = 100; }

        if (enemyProfile != null) enemyMaxHP = enemyProfile.maxHealth;
        else enemyMaxHP = 1000;

        currentPlayerHealth = playerMaxHP;
        currentEnemyHealth = enemyMaxHP;
        currentMana = 0;
    }

    public void RegisterNetworkPlayer(NetworkPlayerController npc, bool isLocal)
    {
        if (isLocal) localNetworkPlayer = npc;
        else remoteNetworkPlayer = npc;

        // Statları Sunucuya Bildir (Sadece Host yapar)
        if (npc.IsServer)
        {
            if (isLocal) npc.SetStatsServer(playerMaxHP, GameManager.Instance.playerData.username);
            else npc.SetStatsServer(enemyMaxHP, GameManager.Instance.currentEnemyName);
        }
    }

    // Network'ten veri gelince çalışır (Ayna Mantığı Burada İşler)
    public void UpdateNetworkUI(bool isOwnerOfObject, float current, float max)
    {
        var ui = UIManager.Instance?.GetPanel<BattleUI>();
        if (ui == null) return;

        // MANTIK: 
        // Eğer güncellenen obje benimse (isOwnerOfObject = true) -> Sol Bar (Local)
        // Eğer güncellenen obje benim değilse (Host veya Rakip) -> Sağ Bar (Remote)
        
        if (isOwnerOfObject) 
        { 
            currentPlayerHealth = current; 
            ui.UpdatePlayerBarOnly(current, max); 
        }
        else 
        { 
            currentEnemyHealth = current; 
            ui.UpdateEnemyBarOnly(current, max); 
        }
        
        CheckWinCondition();
    }

    public void TakeDamage(bool isPlayerTakingDamage, float damageAmount)
    {
        if (!isGameActive) return;

        bool isRealOnlineMatch = (GameManager.Instance.currentMode != GameMode.Practice) && !GameManager.Instance.isFakeBotMatch;

        if (isRealOnlineMatch)
        {
            // === ONLINE HASAR MANTIĞI ===
            // BURADA YEREL DEĞİŞKENLERE (currentPlayerHealth) DOKUNMUYORUZ!
            // Sadece emri veriyoruz, sonuç UpdateNetworkUI ile dönecek.

            if (!isPlayerTakingDamage)
            {
                // Ben rakibe vuruyorum -> Remote objeye RPC at
                if (remoteNetworkPlayer != null)
                {
                    if (playerProfile != null) damageAmount *= playerProfile.redDamageMultiplier;
                    
                    // "RequireOwnership = false" sayesinde Clone da bunu çağırabilir
                    remoteNetworkPlayer.TakeDamageServer(damageAmount);
                    
                    totalDamageDealt += damageAmount;
                    UIManager.Instance?.GetPanel<BattleUI>()?.ShakeScreen(0.2f, 10f);
                    Debug.Log("Rakibe Vurdum (RPC Gönderildi)");
                }
                else
                {
                    Debug.LogWarning("Rakip Network Objesi Bulunamadı! Hasar gitmedi.");
                }
            }
            else
            {
                // Kendime hasar veriyorum (Bomba vs.) -> Local objeye RPC at
                if (localNetworkPlayer != null)
                {
                    if (isPlayerShieldActive) damageAmount *= 0.3f;
                    localNetworkPlayer.TakeDamageServer(damageAmount);
                    UIManager.Instance?.GetPanel<BattleUI>()?.ShakeScreen(0.2f, 15f);
                }
            }
        }
        else
        {
            // === OFFLINE HASAR MANTIĞI ===
            if (isPlayerTakingDamage)
            {
                if (isPlayerShieldActive) damageAmount *= 0.3f;
                currentPlayerHealth -= damageAmount;
                UIManager.Instance?.GetPanel<BattleUI>()?.ShakeScreen(0.2f, 15f);
            }
            else
            {
                if (playerProfile != null) damageAmount *= playerProfile.redDamageMultiplier;
                currentEnemyHealth -= damageAmount;
                totalDamageDealt += damageAmount;
            }
            currentPlayerHealth = Mathf.Max(0, currentPlayerHealth);
            currentEnemyHealth = Mathf.Max(0, currentEnemyHealth);
            var ui = UIManager.Instance?.GetPanel<BattleUI>();
            if (ui != null) ui.UpdateBattleBars(currentPlayerHealth, playerMaxHP, currentEnemyHealth, enemyMaxHP);
            CheckWinCondition();
        }
    }

    // --- DİĞERLERİ AYNI ---
    public void Heal(bool isPlayer, float amount) 
    {
         if (!isGameActive) return;
        if (isPlayer)
        {
            if (playerProfile != null) amount *= playerProfile.greenHealMultiplier;
            currentPlayerHealth += amount;
            currentPlayerHealth = Mathf.Min(currentPlayerHealth, playerMaxHP);
        }
        else
        {
            currentEnemyHealth += amount;
            currentEnemyHealth = Mathf.Min(currentEnemyHealth, enemyMaxHP);
        }
        // Online modda UI elle güncellenmez, Network'ten beklenir
        bool isRealOnlineMatch = (GameManager.Instance.currentMode != GameMode.Practice) && !GameManager.Instance.isFakeBotMatch;
        if (!isRealOnlineMatch)
             UIManager.Instance?.GetPanel<BattleUI>()?.UpdateBattleBars(currentPlayerHealth, playerMaxHP, currentEnemyHealth, enemyMaxHP);
    }
    public void AddMana(float amount) {
        if (playerProfile != null) amount *= playerProfile.blueManaMultiplier;
        currentMana += amount;
        currentMana = Mathf.Min(currentMana, playerMaxMana);
        UIManager.Instance?.GetPanel<BattleUI>()?.UpdateMana(currentMana, playerMaxMana);
    }
    public void UseSkill() {
        if (currentMana >= playerMaxMana && playerProfile != null && playerProfile.activeSkill != null)
        {
            playerProfile.activeSkill.Trigger(this, EnemyManager.Instance, true);
            currentMana = 0;
            UIManager.Instance?.GetPanel<BattleUI>()?.UpdateMana(currentMana, playerMaxMana);
        }
    }
    public void ActivatePlayerShield(float duration) {
        isPlayerShieldActive = true; shieldDuration = duration;
        UIManager.Instance?.GetPanel<BattleUI>()?.SetPlayerShield(true);
    }
    void DeactivateShield() {
        isPlayerShieldActive = false;
        UIManager.Instance?.GetPanel<BattleUI>()?.SetPlayerShield(false);
    }
    public void UpdateComboStats(int currentChain) { if (currentChain > maxCombo) maxCombo = currentChain; }
    void UpdateAllUI() {
        var ui = UIManager.Instance?.GetPanel<BattleUI>();
        if (ui != null) {
            ui.UpdateBattleBars(currentPlayerHealth, playerMaxHP, currentEnemyHealth, enemyMaxHP);
            ui.UpdateMana(currentMana, playerMaxMana);
        }
    }
    void CheckWinCondition() { if (currentEnemyHealth <= 0 || currentPlayerHealth <= 0) EndGame(); }
    void EndGame(bool opponentFled = false)
    {
        if (!isGameActive) return;
        isGameActive = false;
        
        if (EnemyManager.Instance != null) EnemyManager.Instance.StopBattle();

        bool isVictory = currentPlayerHealth > currentEnemyHealth;
        if (opponentFled) isVictory = true; // Rakip kaçtıysa kesin zafer

        if (EndGameManager.Instance != null)
        {
            // İstersen ProcessGameResult'a "opponentFled" parametresi ekleyip 
            // Sonuç ekranında "Rakip Korkup Kaçtı!" yazdırabilirsin.
            EndGameManager.Instance.ProcessGameResult(isVictory, totalDamageDealt, maxCombo, matchDurationCounter, currentPlayerHealth);
        }
    }
    public void EnemyUseSkill() {
        if (enemyProfile != null && enemyProfile.activeSkill != null) enemyProfile.activeSkill.Trigger(this, EnemyManager.Instance, false);
    }
}


---------------- FILE: BoardManager.cs ----------------
using UnityEngine;
using UnityEngine.UI;
using System.Collections;
using System.Collections.Generic;
using System.Linq;

public class BoardManager : MonoBehaviour
{
    [Header("Seviye Tasarımı")]
    public LevelData currentLevel; 

    [Header("Grid Ayarları")]
    [HideInInspector] public int width;
    [HideInInspector] public int height;
    public float spacing = 10f; 
    public float padding = 20f; 
    
    [Header("UI Referansları")]
    public RectTransform boardPanel; 
    public GameObject tilePrefab;    
    public Texture2D[] tileTextures; 
    
    private Sprite[] cachedSprites; 
    public int[] gridData; 
    private List<int> tileBag = new List<int>(); 
    private GameObject[,] tileObjects; 
    private float tileSize;

    private bool isProcessingMove = false;
    public bool IsBoardLocked() { return isProcessingMove; }
    
    private int currentElo = 1200;

    void Start()
    {
        if (currentLevel == null)
        {
            Debug.LogError("LevelData Eksik!");
            return;
        }

        width = currentLevel.width;
        height = currentLevel.height;

        GenerateSpritesFromTextures();
        gridData = new int[width * height];
        tileObjects = new GameObject[width, height];

        SetupWallsFromLevelData();
        CalculateTileSize();
        InitializeBoardLogic(currentElo); 
        DrawBoardUI();
    }

    public void AttemptSwap(int x1, int y1, int dirX, int dirY)
    {
        if (isProcessingMove) return;

        int x2 = x1 + dirX;
        int y2 = y1 + dirY;

        if (x2 < 0 || x2 >= width || y2 < 0 || y2 >= height) return;
        if (gridData[x1 + y1 * width] == -1 || gridData[x2 + y2 * width] == -1) return;

        StartCoroutine(ProcessSwap(x1, y1, x2, y2));
    }

    IEnumerator ProcessSwap(int x1, int y1, int x2, int y2)
    {
        isProcessingMove = true;
        DoSwap(x1, y1, x2, y2);
        yield return new WaitForSeconds(0.25f);

        List<GameObject> matchedTiles = FindMatchesSimple();

        if (matchedTiles.Count > 0)
        {
            yield return StartCoroutine(ProcessGameLoop(matchedTiles));
        }
        else
        {
            DoSwap(x1, y1, x2, y2);
            yield return new WaitForSeconds(0.25f);
            isProcessingMove = false;
        }
    }

    IEnumerator ProcessGameLoop(List<GameObject> initialMatches)
    {
        List<GameObject> currentMatches = initialMatches;
        
        // --- KOMBO SAYACI BAŞLANGICI ---
        int chainCounter = 0; 
        // -------------------------------

        while (currentMatches.Count > 0)
        {
            chainCounter++; // Her patlama döngüsünde komboyu artır

            int redCount = 0;
            int blueCount = 0;
            bool greenFound = false;

            foreach (GameObject tile in currentMatches)
            {
                if (tile != null)
                {
                    TileController tc = tile.GetComponent<TileController>();
                    
                    if (tc.typeID == 1) redCount++;
                    else if (tc.typeID == 2) blueCount++;
                    else if (tc.typeID == 3) greenFound = true;
                    
                    gridData[tc.x + tc.y * width] = 0; 
                    tileObjects[tc.x, tc.y] = null;    
                    tc.Explode();                      
                }
            }

            if (BattleManager.Instance != null)
            {
                if (redCount > 0) BattleManager.Instance.TakeDamage(false, redCount * 10f);
                if (blueCount > 0) BattleManager.Instance.AddMana(blueCount * 5f);
                if (greenFound) BattleManager.Instance.ActivatePlayerShield(5f);
            }

            yield return new WaitForSeconds(0.25f);
            ApplyGravity();
            RefillBoard();
            yield return new WaitForSeconds(0.25f);

            currentMatches = FindMatchesSimple();
        }

        // --- KOMBOYU GÖNDER ---
        if (BattleManager.Instance != null)
        {
            BattleManager.Instance.UpdateComboStats(chainCounter);
        }

        if (!HasPossibleMoves())
        {
            Debug.Log("Deadlock! Karıştırılıyor...");
            yield return StartCoroutine(ShuffleBoard());
        }
        else
        {
            isProcessingMove = false;
        }
    }

    // --- STANDART FONKSİYONLAR (DEĞİŞİKLİK YOK) ---
    void ApplyGravity()
    {
        for (int x = 0; x < width; x++)
        {
            for (int y = 0; y < height; y++)
            {
                if (gridData[x + y * width] == 0)
                {
                    for (int k = y + 1; k < height; k++)
                    {
                        if (gridData[x + k * width] == -1) break;
                        if (gridData[x + k * width] > 0)
                        {
                            int tileType = gridData[x + k * width];
                            GameObject tileObj = tileObjects[x, k];
                            gridData[x + y * width] = tileType;
                            gridData[x + k * width] = 0;
                            tileObjects[x, y] = tileObj;
                            tileObjects[x, k] = null;
                            TileController tc = tileObj.GetComponent<TileController>();
                            tc.x = x; tc.y = y; tc.name = $"Tile_{x}_{y}";
                            tc.MoveToPosition(GetTilePosition(x, y));
                            break; 
                        }
                    }
                }
            }
        }
    }

    void RefillBoard()
    {
        int activeColors = currentElo > 1200 ? 5 : 4;
        float spawnOffsetY = boardPanel.rect.height / 2f + tileSize;

        for (int x = 0; x < width; x++)
        {
            for (int y = 0; y < height; y++)
            {
                if (gridData[x + y * width] == 0)
                {
                    int newType = GetNextTileFromBag(activeColors);
                    gridData[x + y * width] = newType;
                    Vector2 finalPos = GetTilePosition(x, y);
                    Vector2 startPos = new Vector2(finalPos.x, spawnOffsetY);
                    GameObject newTile = Instantiate(tilePrefab, boardPanel);
                    RectTransform rect = newTile.GetComponent<RectTransform>();
                    rect.sizeDelta = new Vector2(tileSize, tileSize);
                    rect.anchoredPosition = startPos;
                    Sprite spriteToUse = cachedSprites.Length > newType ? cachedSprites[newType] : cachedSprites[0];
                    newTile.GetComponent<TileController>().Initialize(x, y, newType, spriteToUse, this);
                    newTile.GetComponent<TileController>().MoveToPosition(finalPos);
                    tileObjects[x, y] = newTile;
                }
            }
        }
    }

    void SetupWallsFromLevelData()
    {
        for (int i = 0; i < currentLevel.activeSlots.Length; i++)
        {
            if (i < gridData.Length)
            {
                if (currentLevel.activeSlots[i] == false) gridData[i] = -1;
                else gridData[i] = 0;
            }
        }
    }

    void InitializeBoardLogic(int elo)
    {
        int activeColorCount = elo > 1200 ? 5 : 4; 
        RefillBag(activeColorCount);
        for (int x = 0; x < width; x++)
        {
            for (int y = 0; y < height; y++)
            {
                if (gridData[x + y * width] == -1) continue;
                int tile = -1; 
                int maxIterations = 0;
                while (true)
                {
                    tile = Random.Range(1, activeColorCount + 1);
                    bool isMatch = false;
                    if (x >= 2) {
                        int t1 = gridData[(x - 1) + y * width];
                        int t2 = gridData[(x - 2) + y * width];
                        if (t1 != -1 && t2 != -1 && t1 == tile && t2 == tile) isMatch = true;
                    }
                    if (y >= 2) {
                        int t1 = gridData[x + (y - 1) * width];
                        int t2 = gridData[x + (y - 2) * width];
                        if (t1 != -1 && t2 != -1 && t1 == tile && t2 == tile) isMatch = true;
                    }
                    if (!isMatch) break;
                    maxIterations++;
                    if (maxIterations > 100) break;
                }
                gridData[x + y * width] = tile;
            }
        }
    }

    void DrawBoardUI()
    {
        for (int x = 0; x < width; x++)
        {
            for (int y = 0; y < height; y++)
            {
                int tileType = gridData[x + y * width];
                if (tileType > 0)
                {
                    Vector2 pos = GetTilePosition(x, y);
                    GameObject newTile = Instantiate(tilePrefab, boardPanel);
                    RectTransform rect = newTile.GetComponent<RectTransform>();
                    rect.sizeDelta = new Vector2(tileSize, tileSize);
                    rect.anchoredPosition = pos;
                    Sprite spriteToUse = cachedSprites.Length > tileType ? cachedSprites[tileType] : cachedSprites[0];
                    newTile.GetComponent<TileController>().Initialize(x, y, tileType, spriteToUse, this);
                    tileObjects[x, y] = newTile;
                }
            }
        }
    }

    IEnumerator ShuffleBoard()
    {
        yield return new WaitForSeconds(0.5f);
        List<int> currentTiles = new List<int>();
        for (int i = 0; i < gridData.Length; i++)
        {
            if (gridData[i] > 0) currentTiles.Add(gridData[i]);
        }
        int maxRetry = 10;
        bool playableBoardFound = false;
        while (!playableBoardFound && maxRetry > 0)
        {
            for (int i = 0; i < currentTiles.Count; i++) {
                int temp = currentTiles[i];
                int r = Random.Range(i, currentTiles.Count);
                currentTiles[i] = currentTiles[r];
                currentTiles[r] = temp;
            }
            int listIndex = 0;
            for (int i = 0; i < gridData.Length; i++)
            {
                if (gridData[i] != -1)
                {
                    gridData[i] = currentTiles[listIndex];
                    listIndex++;
                }
            }
            if (FindMatchesSimple().Count == 0 && HasPossibleMoves()) playableBoardFound = true;
            else maxRetry--;
        }
        for (int x = 0; x < width; x++)
        {
            for (int y = 0; y < height; y++)
            {
                if (gridData[x + y * width] > 0)
                {
                    int type = gridData[x + y * width];
                    GameObject tileObj = tileObjects[x, y];
                    TileController tc = tileObj.GetComponent<TileController>();
                    tc.typeID = type;
                    Image img = tileObj.GetComponent<Image>();
                    img.sprite = cachedSprites.Length > type ? cachedSprites[type] : cachedSprites[0];
                }
            }
        }
        isProcessingMove = false;
    }

    bool HasPossibleMoves()
    {
        int[] tempGrid = (int[])gridData.Clone();
        for (int y = 0; y < height; y++) {
            for (int x = 0; x < width; x++) {
                if (tempGrid[x + y * width] == -1) continue;
                if (x < width - 1 && tempGrid[(x + 1) + y * width] != -1) {
                    if (CheckSwapSimulation(x, y, x + 1, y, tempGrid)) return true;
                }
                if (y < height - 1 && tempGrid[x + (y + 1) * width] != -1) {
                    if (CheckSwapSimulation(x, y, x, y + 1, tempGrid)) return true;
                }
            }
        }
        return false;
    }

    bool CheckSwapSimulation(int x1, int y1, int x2, int y2, int[] tempGrid)
    {
        int i1 = x1 + y1 * width; int i2 = x2 + y2 * width;
        int t1 = tempGrid[i1]; int t2 = tempGrid[i2];
        tempGrid[i1] = t2; tempGrid[i2] = t1;
        bool hasMatch = CheckMatchAt(x1, y1, tempGrid) || CheckMatchAt(x2, y2, tempGrid);
        tempGrid[i1] = t1; tempGrid[i2] = t2;
        return hasMatch;
    }

    bool CheckMatchAt(int x, int y, int[] grid)
    {
        int type = grid[x + y * width];
        if (type <= 0) return false;
        if (x >= 2 && grid[(x-1)+y*width] == type && grid[(x-2)+y*width] == type) return true;
        if (x >= 1 && x < width-1 && grid[(x-1)+y*width] == type && grid[(x+1)+y*width] == type) return true;
        if (x < width-2 && grid[(x+1)+y*width] == type && grid[(x+2)+y*width] == type) return true;
        if (y >= 2 && grid[x+(y-1)*width] == type && grid[x+(y-2)*width] == type) return true;
        if (y >= 1 && y < height-1 && grid[x+(y-1)*width] == type && grid[x+(y+1)*width] == type) return true;
        if (y < height-2 && grid[x+(y+1)*width] == type && grid[x+(y+2)*width] == type) return true;
        return false;
    }

    List<GameObject> FindMatchesSimple()
    {
        HashSet<GameObject> matchedSet = new HashSet<GameObject>();
        for (int y = 0; y < height; y++) {
            for (int x = 0; x < width; x++) {
                int currentType = gridData[x + y * width];
                if (currentType <= 0) continue;
                int matchCount = 1;
                for (int k = x + 1; k < width; k++) {
                    if (gridData[k + y * width] == currentType) matchCount++; else break;
                }
                if (matchCount >= 3) for (int k = 0; k < matchCount; k++) matchedSet.Add(tileObjects[x + k, y]);
            }
        }
        for (int x = 0; x < width; x++) {
            for (int y = 0; y < height; y++) {
                int currentType = gridData[x + y * width];
                if (currentType <= 0) continue;
                int matchCount = 1;
                for (int k = y + 1; k < height; k++) {
                    if (gridData[x + k * width] == currentType) matchCount++; else break;
                }
                if (matchCount >= 3) for (int k = 0; k < matchCount; k++) matchedSet.Add(tileObjects[x, y + k]);
            }
        }
        return matchedSet.ToList();
    }

    void DoSwap(int x1, int y1, int x2, int y2)
    {
        int index1 = x1 + y1 * width; int index2 = x2 + y2 * width;
        int tempType = gridData[index1]; gridData[index1] = gridData[index2]; gridData[index2] = tempType;
        GameObject tempObj = tileObjects[x1, y1];
        tileObjects[x1, y1] = tileObjects[x2, y2]; tileObjects[x2, y2] = tempObj;
        TileController t1 = tileObjects[x1, y1].GetComponent<TileController>(); t1.x = x1; t1.y = y1; t1.name = $"Tile_{x1}_{y1}";
        TileController t2 = tileObjects[x2, y2].GetComponent<TileController>(); t2.x = x2; t2.y = y2; t2.name = $"Tile_{x2}_{y2}";
        UpdateTilePosition(tileObjects[x1, y1], x1, y1); UpdateTilePosition(tileObjects[x2, y2], x2, y2);
    }

    void UpdateTilePosition(GameObject tile, int x, int y) { tile.GetComponent<TileController>().MoveToPosition(GetTilePosition(x, y)); }

    Vector2 GetTilePosition(int x, int y) {
        float totalGridWidth = (width * tileSize) + ((width - 1) * spacing);
        float totalGridHeight = (height * tileSize) + ((height - 1) * spacing);
        float startX = -totalGridWidth / 2f + (tileSize / 2f);
        float startY = -totalGridHeight / 2f + (tileSize / 2f);
        return new Vector2(startX + (x * (tileSize + spacing)), startY + (y * (tileSize + spacing)));
    }

    void GenerateSpritesFromTextures() {
        cachedSprites = new Sprite[tileTextures.Length];
        for (int i = 0; i < tileTextures.Length; i++) {
            if (tileTextures[i] != null) {
                Texture2D tex = tileTextures[i];
                cachedSprites[i] = Sprite.Create(tex, new Rect(0, 0, tex.width, tex.height), new Vector2(0.5f, 0.5f));
            }
        }
    }

    void CalculateTileSize() {
        float usableWidth = boardPanel.rect.width - (spacing * (width - 1)) - (padding * 2);
        float usableHeight = boardPanel.rect.height - (spacing * (height - 1)) - (padding * 2);
        tileSize = Mathf.Min(usableWidth / width, usableHeight / height);
    }

    void RefillBag(int maxColors) {
        tileBag.Clear(); for (int i = 1; i <= maxColors; i++) for (int j = 0; j < 10; j++) tileBag.Add(i);
    }

    public int GetNextTileFromBag(int maxColors) {
        if (tileBag.Count == 0) RefillBag(maxColors);
        int index = Random.Range(0, tileBag.Count);
        int selectedTile = tileBag[index]; tileBag.RemoveAt(index); return selectedTile;
    }
}


---------------- FILE: EndGameManager.cs ----------------
using UnityEngine;
using UnityEngine.SceneManagement;

public class EndGameManager : MonoBehaviour
{
    public static EndGameManager Instance;

    [Header("Veri Ayarları")]
    public RankData rankData; 
    public int baseXPGain = 100;

    private void Awake()
    {
        Instance = this;
    }

    public void ProcessGameResult(bool isVictory, float damage, int combo, float time, float remainingHP)
    {
        EndGameUI ui = UIManager.Instance.GetPanel<EndGameUI>();
        if (ui == null) return;
        
        UIManager.Instance.ShowPanel<EndGameUI>();

        PlayerData data = GameManager.Instance.playerData;
        GameMode currentMode = GameManager.Instance.currentMode; // Modu al

        // --- 1. ELO HESAPLAMA (Sadece Ranked) ---
        int eloChange = 0;
        
        if (currentMode == GameMode.Ranked)
        {
            eloChange = isVictory ? 25 : -15;
            data.elo += eloChange;
            Debug.Log("Ranked Maç Bitti. Elo Güncellendi.");
        }
        else
        {
            Debug.Log($"{currentMode} Modu: Elo değişmedi.");
        }

        // --- 2. ALTIN VE XP (Her modda verilebilir ama oranları farklı olabilir) ---
        int goldEarned = 0;
        int xpEarned = 0;

        if (isVictory)
        {
            if (currentMode == GameMode.Ranked) { goldEarned = 100; xpEarned = 100; }
            else if (currentMode == GameMode.Casual) { goldEarned = 50; xpEarned = 50; }
            else if (currentMode == GameMode.Practice) { goldEarned = 10; xpEarned = 10; } // Bot farmını önlemek için az ver
        }
        else
        {
            goldEarned = 10; // Teselli ödülü
        }

        data.gold += goldEarned;
        data.currentXP += xpEarned;

        // Level Atlama Kontrolü (Aynen kalsın)
        if (data.currentXP >= data.requiredXP)
        {
            data.currentXP -= data.requiredXP;
            data.level++;
            data.requiredXP *= 1.2f;
        }

        // --- KAYDET ---
        GameManager.Instance.SaveGame();
        
        // --- İSTATİSTİK GÖNDERME (YENİ) ---
        // Sadece Ranked modunda Elo gönderilir
        if (GameManager.Instance.currentMode == GameMode.Ranked)
        {
            PlayFabManager.Instance.SendLeaderboardStats(data.elo, data.level);
        }
        // Level her modda gönderilebilir (İstersen) practice dışında casualda da level gitsin.
        else 
        {
            // PlayFabManager.Instance.SendLeaderboardStats(data.elo, data.level); // Opsiyonel
        }

        // --- UI GÜNCELLEME ---
        var currentRank = rankData.GetRankByElo(data.elo);
        var nextRank = rankData.GetNextRank(data.elo);

        // Görsel hesaplamalar...
        float range = nextRank.minElo - currentRank.minElo;
        float progress = (range > 0) ? (float)(data.elo - currentRank.minElo) / range : 1;

        ui.SetVictoryStatus(isVictory);
        ui.SetEloVisuals(data.elo, eloChange, currentRank.rankIcon, nextRank.rankIcon, progress);
        ui.SetLevelVisuals(data.level, data.currentXP / data.requiredXP);
        ui.SetStats(damage, combo, time, remainingHP);

        // Butonlar (Rematch mantığı modlara göre değişebilir ama şimdilik kalsın)
        ui.rematchButton.onClick.RemoveAllListeners();
        ui.rematchButton.onClick.AddListener(() => SceneManager.LoadScene(SceneManager.GetActiveScene().name));

        ui.mainMenuButton.onClick.RemoveAllListeners();
        ui.mainMenuButton.onClick.AddListener(() => SceneManager.LoadScene("Main Menu"));
    }
}


---------------- FILE: EnemyManager.cs ----------------
using UnityEngine;
using System.Collections;

public class EnemyManager : MonoBehaviour
{
    public static EnemyManager Instance;

    [Header("Bot Davranış Ayarları")]
    public float minAttackInterval = 3f;  
    public float maxAttackInterval = 6f;  

    [Header("Olasılıklar")]
    [Range(0, 100)] public int comboChance = 30; 
    [Range(0, 100)] public int skillChance = 20; 

    [Header("Görsel Referanslar")]
    public GameObject projectilePrefab; 
    public Transform firePoint;         
    public Transform targetPoint;       

    private bool isFighting = false;
    
    // Verileri BattleManager'dan çekeceğiz
    private float damageFromProfile;
    private float speedMultiplier;

    private void Awake()
    {
        Instance = this;
    }

    void Start()
    {
        // --- MULTIPLAYER KONTROLÜ ---
        // Eğer Ranked modundaysak (yani Online oynuyorsak), bu bot scriptini yok et.
        if (GameManager.Instance.currentMode == GameMode.Ranked)
        {
            Debug.Log("Ranked Modu: Bot devre dışı bırakılıyor.");
            Destroy(gameObject); // Kendini yok et
            return;
        }
        // ----------------------------
        
        if (projectilePrefab == null || firePoint == null || targetPoint == null)
        {
            Debug.LogWarning("EnemyManager: Referanslar eksik!");
            return;
        }

        StartCoroutine(StartBattleDelayed());
    }

    IEnumerator StartBattleDelayed()
    {
        // BattleManager'ın hazırlanmasını bekle
        yield return new WaitForSeconds(0.5f);
        
        // Verileri Yükle
        if (BattleManager.Instance != null && BattleManager.Instance.enemyProfile != null)
        {
            CharacterData data = BattleManager.Instance.enemyProfile;
            damageFromProfile = data.baseAttackDamage;
            speedMultiplier = data.attackSpeedMultiplier;
            Debug.Log($"Bot Hazır: {data.characterName} (Hasar: {damageFromProfile}, Hız: {speedMultiplier}x)");
        }
        else
        {
            damageFromProfile = 15f; // Varsayılan
            speedMultiplier = 1f;
        }

        StartBattle();
    }

    public void StartBattle()
    {
        if (!isFighting)
        {
            isFighting = true;
            StartCoroutine(EnemyLogicLoop());
        }
    }

    public void StopBattle()
    {
        isFighting = false;
        StopAllCoroutines();
    }

    IEnumerator EnemyLogicLoop()
    {
        yield return new WaitForSeconds(2f); // Başlangıç nezaketi

        while (isFighting)
        {
            // Bekleme süresini karaktere göre ayarla (Hızlı karakter az bekler)
            float baseWait = Random.Range(minAttackInterval, maxAttackInterval);
            float actualWait = baseWait / speedMultiplier; 
            yield return new WaitForSeconds(actualWait);

            // %20 ihtimalle Skill, yoksa Normal Saldırı
            int roll = Random.Range(0, 100);

            if (roll < skillChance)
            {
                // Skill Kullan (Mermi yok, direkt yetenek çalışır)
                if (BattleManager.Instance != null)
                    BattleManager.Instance.EnemyUseSkill();
            }
            else
            {
                // Normal Saldırı (Mermi atar)
                SpawnProjectile(damageFromProfile);

                // Kombo Şansı
                int comboRoll = Random.Range(0, 100);
                if (comboRoll < comboChance)
                {
                    yield return new WaitForSeconds(0.5f);
                    SpawnProjectile(damageFromProfile);
                }
            }
        }
    }

    void SpawnProjectile(float damage)
    {
        if (projectilePrefab != null && firePoint != null)
        {
            GameObject proj = Instantiate(projectilePrefab, firePoint.position, Quaternion.identity);
            
            // UI hiyerarşisinde doğru yere koy
            proj.transform.SetParent(firePoint.parent, true);
            proj.transform.localScale = Vector3.one;

            ProjectileController pc = proj.GetComponent<ProjectileController>();
            if (pc != null)
            {
                // isEnemyAttack = true, Hedef = targetPoint
                pc.Initialize(damage, true, targetPoint.position);
            }
        }
    }
}


---------------- FILE: GameManager.cs ----------------
using System;
using UnityEngine;
using System.Collections.Generic;
using PlayFab;
using PlayFab.ClientModels;
using Newtonsoft.Json;

public class GameManager : MonoBehaviour
{
    public static GameManager Instance;

    [Header("Oyun Verileri")]
    public PlayerData playerData = new PlayerData();
    public CharacterData selectedCharacter;
    public GameMode currentMode;
    
    [Header("Görsel Kütüphane (Inspector'dan Doldur!)")]
    public List<Sprite> avatarList; // Tüm avatarları buraya sürükle
    public List<Sprite> frameList;  // Tüm çerçeveleri buraya sürükle

    [Header("Mevcut Maç Verileri (YENİ)")]
    // Savaş sahnesine taşınacak rakip verileri
    public string currentEnemyName = "Enemy";
    public int currentEnemyElo = 1200;
    public int currentEnemyLevel = 1;
    public CharacterData currentEnemyCharacter; // Rakibin karakteri
    public int currentEnemyAvatarId = 0;
    public int currentEnemyFrameId = 0;
    
    // Fake Bot Kontrolü
    public bool isFakeBotMatch = false; 

    public event Action OnDataUpdated;

    [Header("Veritabanı")]
    public List<CharacterData> allCharacters; 

    private void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
            LoadLocalSettings();
        }
        else { Destroy(gameObject); }
    }
    
    // --- RESİM GETİRME YARDIMCILARI ---
    public Sprite GetAvatarSprite(int id)
    {
        if (avatarList != null && id >= 0 && id < avatarList.Count) return avatarList[id];
        return null; // veya varsayılan bir sprite
    }

    public Sprite GetFrameSprite(int id)
    {
        if (frameList != null && id >= 0 && id < frameList.Count) return frameList[id];
        return null;
    }

    // --- RAKİP VERİSİ KAYDETME (GÜNCELLENDİ) ---
    public void SetMatchOpponent(string name, int elo, int level, string charName, int avatarId, int frameId)
    {
        currentEnemyName = name;
        currentEnemyElo = elo;
        currentEnemyLevel = level;
        currentEnemyAvatarId = avatarId;
        currentEnemyFrameId = frameId;
        
        CharacterData foundChar = allCharacters.Find(x => x.characterName == charName);
        if (foundChar != null) currentEnemyCharacter = foundChar;
        else if (allCharacters.Count > 0) currentEnemyCharacter = allCharacters[0];
    }

    public void SetGameMode(GameMode mode)
    {
        currentMode = mode;
        isFakeBotMatch = false; 
        PlayerPrefs.SetInt("LastGameMode", (int)mode);
        PlayerPrefs.Save();
    }

    private void LoadLocalSettings()
    {
        if (PlayerPrefs.HasKey("LastGameMode")) currentMode = (GameMode)PlayerPrefs.GetInt("LastGameMode");
        else currentMode = GameMode.Casual;
    }

    public void SetCharacter(CharacterData character)
    {
        selectedCharacter = character;
        if (character != null)
        {
            playerData.lastSelectedCharacterName = character.characterName;
            SaveGame(); 
        }
    }

    public void OnDataLoadedFromPlayFab(PlayerData loadedData)
    {
        playerData = loadedData;
        if (!string.IsNullOrEmpty(playerData.lastSelectedCharacterName))
        {
            CharacterData foundChar = allCharacters.Find(x => x.characterName == playerData.lastSelectedCharacterName);
            if (foundChar != null) selectedCharacter = foundChar;
        }
        OnDataUpdated?.Invoke();
    }

    public void SaveGame()
    {
        if (PlayFabManager.Instance != null && PlayFabManager.Instance.isLoggedIn)
            PlayFabManager.Instance.SaveData(playerData);
    }
    
    private void OnApplicationPause(bool pauseStatus) { if (pauseStatus) SaveGame(); }
    private void OnApplicationQuit() { SaveGame(); }
}


---------------- FILE: InGameMenuManager.cs ----------------
using UnityEngine;
using UnityEngine.UI;

public class InGameMenuManager : MonoBehaviour
{
    [Header("Sahne Referansı")]
    public Button openMenuButton; // Sağ üstteki menü açma butonu

    void Start()
    {
        // 1. Menü Açma Butonunu Bağla (Sağ Üstteki Dişli)
        if (openMenuButton != null)
        {
            openMenuButton.onClick.RemoveAllListeners();
            openMenuButton.onClick.AddListener(OpenMenuPanel);
        }

        // 2. Panel İçi Butonları Bağla
        // UIManager üzerinden paneli buluyoruz
        InGameMenuUI ui = UIManager.Instance.GetPanel<InGameMenuUI>();
        if (ui != null)
        {
            // Butonları temizle ve yeniden bağla
            ui.resumeButton.onClick.RemoveAllListeners();
            ui.resumeButton.onClick.AddListener(CloseMenuPanel);

            ui.settingsButton.onClick.RemoveAllListeners();
            ui.settingsButton.onClick.AddListener(OnSettingsClicked); // BURAYI DÜZELTTİK

            ui.surrenderButton.onClick.RemoveAllListeners();
            ui.surrenderButton.onClick.AddListener(Surrender);
            
            // Başlangıçta paneli gizle
            ui.Hide();
        }
    }

    // Menü panelini açar
    void OpenMenuPanel()
    {
        UIManager.Instance.GetPanel<InGameMenuUI>().Show();
    }

    // Menü panelini kapatır (Devam Et)
    void CloseMenuPanel()
    {
        UIManager.Instance.GetPanel<InGameMenuUI>().Hide();
    }

    // Ayarlar butonuna basılınca çalışır
    void OnSettingsClicked()
    {
        // 1. Önce bu küçük menüyü gizle
        CloseMenuPanel();

        // 2. SettingsManager üzerinden büyük ayarlar panelini aç
        if (SettingsManager.Instance != null)
        {
            SettingsManager.Instance.OpenSettings();
        }
        else
        {
            Debug.LogError("SettingsManager sahnede bulunamadı!");
        }
    }

    void Surrender()
    {
        if (BattleManager.Instance != null)
        {
            CloseMenuPanel();
            
            // Mevcut can kadar hasar alıp öl
            float currentHP = BattleManager.Instance.currentPlayerHealth;
            BattleManager.Instance.TakeDamage(true, currentHP + 100); 
            
            Debug.Log("Oyuncu Teslim Oldu.");
        }
    }
}


---------------- FILE: MainMenuManager.cs ----------------
using System;
using UnityEngine;
using System.Collections.Generic;
using UnityEngine.SceneManagement;

public class MainMenuManager : MonoBehaviour
{
    public static MainMenuManager Instance;

    private HeroesUI heroesUI;
    private LobbyUI lobbyUI;
    
    [Header("Veri")]
    public List<CharacterData> availableCharacters; 
    private int currentIndex = 0;

    private void Awake() { Instance = this; }

    private void OnEnable()
    {
        // Script aktif olunca dinlemeye başla
        if (GameManager.Instance != null)
        {
            GameManager.Instance.OnDataUpdated += UpdateAllPanels;
        }
    }

    private void OnDisable()
    {
        // Script kapanınca (veya sahne değişince) dinlemeyi bırak
        // Bunu yapmazsan hafıza kaçağı (Memory Leak) olur!
        if (GameManager.Instance != null)
        {
            GameManager.Instance.OnDataUpdated -= UpdateAllPanels;
        }
    }

    void Start()
    {
        // ------------------------------------------------------------
        // 1. LOBBY PANEL BAĞLANTILARI
        // ------------------------------------------------------------
        lobbyUI = UIManager.Instance.GetPanel<LobbyUI>();
        heroesUI = UIManager.Instance.GetPanel<HeroesUI>();
        if (lobbyUI != null)
        {
            // SAVAŞ Butonu -> StartGameLoop fonksiyonuna gider
            lobbyUI.playButton.onClick.RemoveAllListeners();
            lobbyUI.playButton.onClick.AddListener(StartGameLoop);

            // Mod Seçim Butonu -> Mod panelini açar
            lobbyUI.gameModeButton.onClick.RemoveAllListeners();
            lobbyUI.gameModeButton.onClick.AddListener(OpenModeSelection);

            lobbyUI.settingsButton.onClick.RemoveAllListeners();
            lobbyUI.settingsButton.onClick.AddListener(() => SettingsManager.Instance.OpenSettings());
            
            heroesUI.backButton.onClick.RemoveAllListeners();
            heroesUI.backButton.onClick.AddListener(lobbyUI.GoToLobby);
            
            // BAŞLANGIÇ: Her şey hazırsa Lobby'e git
            lobbyUI.GoToLobby();
        }

        // ------------------------------------------------------------
        // 2. HEROES (KARAKTER) PANEL BAĞLANTILARI
        // ------------------------------------------------------------
        if (heroesUI != null)
        {
            heroesUI.nextButton.onClick.RemoveAllListeners();
            heroesUI.nextButton.onClick.AddListener(NextCharacter);

            heroesUI.prevButton.onClick.RemoveAllListeners();
            heroesUI.prevButton.onClick.AddListener(PrevCharacter);

            heroesUI.equipButton.onClick.RemoveAllListeners();
            heroesUI.equipButton.onClick.AddListener(EquipCharacter);

            heroesUI.buyGoldButton.onClick.RemoveAllListeners();
            heroesUI.buyGoldButton.onClick.AddListener(BuyWithGold);

            heroesUI.buyGemButton.onClick.RemoveAllListeners();
            heroesUI.buyGemButton.onClick.AddListener(BuyWithGems);
        }

        // ------------------------------------------------------------
        // 3. MOD SEÇİM PANELİ BAĞLANTILARI
        // ------------------------------------------------------------
        GameModeUI modeUI = UIManager.Instance.GetPanel<GameModeUI>();
        if (modeUI != null)
        {
            modeUI.rankedButton.onClick.RemoveAllListeners();
            modeUI.rankedButton.onClick.AddListener(() => SelectMode(GameMode.Ranked));

            modeUI.casualButton.onClick.RemoveAllListeners();
            modeUI.casualButton.onClick.AddListener(() => SelectMode(GameMode.Casual));

            modeUI.practiceButton.onClick.RemoveAllListeners();
            modeUI.practiceButton.onClick.AddListener(() => SelectMode(GameMode.Practice));

            modeUI.closeButton.onClick.RemoveAllListeners();
            modeUI.closeButton.onClick.AddListener(() => modeUI.Hide());
        }
    }

    // ========================================================================
    // OYUN AKIŞI (GAME FLOW) - KRİTİK DÜZELTME BURADA
    // ========================================================================

    void StartGameLoop()
    {
        // 1. GameManager Kontrolü
        if (GameManager.Instance == null) return;

        // 2. KARAKTER SEÇİLİ Mİ KONTROLÜ (YENİ)
        if (GameManager.Instance.selectedCharacter == null)
        {
            Debug.LogWarning("⚠️ Bir karakter seçmelisin!");
            
            // Kullanıcıya görsel bir uyarı ver (Popup veya Karakter ekranına yönlendir)
            lobbyUI.GoToHeroes(); // Otomatik olarak karakter seçme ekranına atıyoruz
            return;
        }

        // 3. Her şey tamamsa Eşleşme Sahnesine git
        GameMode currentMode = GameManager.Instance.currentMode;
        Debug.Log($"Eşleşme Başlatılıyor... Mod: {currentMode}");
        
        SceneManager.LoadScene("MatchFindingScene");
    }

    void SelectMode(GameMode mode)
    {
        if (GameManager.Instance != null)
        {
            // Modu hem değişkene hem de PlayerPrefs'e kaydeder (GameManager içindeki metod sayesinde)
            GameManager.Instance.SetGameMode(mode);
        }
        
        Debug.Log($"Mod Seçildi: {mode}");
        UIManager.Instance.GetPanel<GameModeUI>().Hide();
        UpdateAllPanels();
    }

    // ... (GoToLobby, GoToHeroes, OpenModeSelection, OpenLeaderboardOverlay AYNI) ...
    
    

    public void OpenModeSelection() => UIManager.Instance.GetPanel<GameModeUI>().Show();
    public void OpenLeaderboardOverlay() => UIManager.Instance.GetPanel<LeaderboardUI>().Show();

    // ... (Karakter Yönetimi (Next, Prev, Equip, Buy) AYNI) ...
    
    void NextCharacter()
    {
        currentIndex++;
        if (currentIndex >= availableCharacters.Count) currentIndex = 0;
        UpdateAllPanels();
    }

    void PrevCharacter()
    {
        currentIndex--;
        if (currentIndex < 0) currentIndex = availableCharacters.Count - 1;
        UpdateAllPanels();
    }

    void EquipCharacter()
    {
        CharacterData selectedChar = availableCharacters[currentIndex];
        
        if (GameManager.Instance != null)
        {
            GameManager.Instance.SetCharacter(selectedChar); // Hem seçer hem PlayFab'a kaydeder
        }

        UpdateAllPanels();
    }

    void BuyWithGold() { PerformPurchase(true); }
    void BuyWithGems() { PerformPurchase(false); }

    void PerformPurchase(bool useGold)
    {
        CharacterData charData = availableCharacters[currentIndex];
        PlayerData pData = GameManager.Instance.playerData;
        int price = useGold ? charData.goldPrice : charData.gemPrice;

        if (useGold && pData.gold >= price)
        {
            pData.gold -= price;
            UnlockCharacter(charData.characterName);
        }
        else if (!useGold && pData.gems >= price)
        {
            pData.gems -= price;
            UnlockCharacter(charData.characterName);
        }
        else
        {
            Debug.Log("Yetersiz Bakiye!");
        }
    }

    void UnlockCharacter(string charName)
    {
        if (GameManager.Instance != null)
        {
            GameManager.Instance.playerData.unlockedCharacters.Add(charName);
            // Satın alınca otomatik seç ve kaydet
            GameManager.Instance.SetCharacter(availableCharacters[currentIndex]);
        }
        UpdateAllPanels();
    }

    // UI GÜNCELLEME
    public void UpdateAllPanels()
    {
        if (GameManager.Instance == null) return;

        PlayerData pData = GameManager.Instance.playerData;
        CharacterData currentViewChar = availableCharacters[currentIndex];
        CharacterData equippedChar = GameManager.Instance.selectedCharacter;

        // Heroes
        HeroesUI heroesUI = UIManager.Instance.GetPanel<HeroesUI>();
        if (heroesUI != null && heroesUI.gameObject.activeSelf)
        {
            bool isUnlocked = pData.unlockedCharacters.Contains(currentViewChar.characterName) || currentViewChar.isDefaultUnlocked;
            bool isEquipped = (equippedChar != null && equippedChar.characterName == currentViewChar.characterName);
            heroesUI.UpdateVisuals(currentViewChar, pData, isUnlocked, isEquipped);
        }

        // Lobby
        LobbyUI lobby = UIManager.Instance.GetPanel<LobbyUI>();
        if (lobby != null && lobby.gameObject.activeSelf)
        {
            lobby.UpdateVisuals(pData, equippedChar, GameManager.Instance.currentMode);
        }
    }
}


---------------- FILE: PlayFabManager.cs ----------------
using UnityEngine;
using PlayFab;
using PlayFab.ClientModels;
using System.Collections.Generic;
using System;
using Newtonsoft.Json; // ARTIK STANDART BU

public class PlayFabManager : MonoBehaviour
{
    public static PlayFabManager Instance;

    [Header("Durum")]
    public bool isLoggedIn = false;
    public string playFabId;
    public string displayName;

    // Eventler
    public static event Action<List<PlayFab.ClientModels.PlayerLeaderboardEntry>> OnLeaderboardLoaded;
    public static event Action<List<FriendInfo>> OnFriendsLoaded;

    private void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
        }
        else
        {
            Destroy(gameObject);
        }
    }

    void Start()
    {
        Login(); // Oyunu açınca otomatik gir
    }

    // =================================================================================
    // 1. KİMLİK VE GİRİŞ (AUTH)
    // =================================================================================

    public void Login()
    {
        Debug.Log("Sunucuya bağlanılıyor...");

        // Varsayılan ID (Gerçek Cihaz ID'si)
        string customId = SystemInfo.deviceUniqueIdentifier;

        // --- PARRELSYNC AYARI (Sadece Editörde Çalışır) ---
#if UNITY_EDITOR
        // Eğer ParrelSync klonu ise, ID'yi değiştir ki farklı oyuncu sayılsın
        if (ParrelSync.ClonesManager.IsClone())
        {
            Debug.Log("ParrelSync Klonu Algılandı: Farklı ID kullanılıyor.");
            customId += "_Clone"; // Örn: DeviceID_Clone olur
        }
#endif
        // --------------------------------------------------

        var request = new LoginWithCustomIDRequest
        {
            CustomId = customId, // Güncellenmiş ID'yi kullan
            CreateAccount = true,
            TitleId = PlayFabSettings.TitleId,
            InfoRequestParameters = new GetPlayerCombinedInfoRequestParams
            {
                GetPlayerProfile = true,
                GetTitleData = true 
            }
        };

        PlayFabClientAPI.LoginWithCustomID(request, OnLoginSuccess, OnLoginFailure);
    }

    void OnLoginSuccess(LoginResult result)
    {
        isLoggedIn = true;
        playFabId = result.PlayFabId;
        
        if (result.InfoResultPayload.PlayerProfile != null)
        {
            displayName = result.InfoResultPayload.PlayerProfile.DisplayName;
        }

        Debug.Log($"<color=green>GİRİŞ BAŞARILI!</color> ID: {playFabId}, İsim: {displayName}");
        
        // Giriş yapar yapmaz verileri çek
        LoadData();
    }

    void OnLoginFailure(PlayFabError error)
    {
        Debug.LogError($"Giriş Hatası: {error.GenerateErrorReport()}");
    }

    public void SubmitName(string nameInput, Action onSuccess = null, Action<string> onError = null)
    {
        var request = new UpdateUserTitleDisplayNameRequest { DisplayName = nameInput };
        
        PlayFabClientAPI.UpdateUserTitleDisplayName(request, result => 
        {
            displayName = result.DisplayName;
            // GameManager'daki ismi de güncelle
            if (GameManager.Instance != null) GameManager.Instance.playerData.username = displayName;
            
            Debug.Log("İsim Güncellendi: " + displayName);
            onSuccess?.Invoke();
        }, 
        error => 
        {
            onError?.Invoke(error.ErrorMessage);
        });
    }

    // =================================================================================
    // 2. VERİ YÖNETİMİ (TEK STANDART: NEWTONSOFT)
    // =================================================================================

    public void SaveData(PlayerData data)
    {
        if (!isLoggedIn) return;

        // DÜZELTME: JsonUtility yerine Newtonsoft kullanıyoruz.
        // Key olarak "PlayerProfile" yerine "PlayerData" kullanıyoruz.
        var request = new UpdateUserDataRequest
        {
            Data = new Dictionary<string, string>
            {
                { "PlayerData", JsonConvert.SerializeObject(data) }
            }
        };

        PlayFabClientAPI.UpdateUserData(request, result => Debug.Log("Bulut Kayıt Başarılı ☁️"), OnError);
    }

    public void LoadData()
    {
        if (!isLoggedIn) return;
        PlayFabClientAPI.GetUserData(new GetUserDataRequest(), OnDataReceived, OnError);
    }

    void OnDataReceived(GetUserDataResult result)
    {
        // DÜZELTME: Anahtar kelime "PlayerData"
        if (result.Data != null && result.Data.ContainsKey("PlayerData"))
        {
            string json = result.Data["PlayerData"].Value;
            
            // DÜZELTME: Newtonsoft ile okuma
            PlayerData loadedData = JsonConvert.DeserializeObject<PlayerData>(json);
            
            if (GameManager.Instance != null)
            {
                // GameManager'a veriyi teslim et, orası karakter seçimini vs. halleder
                GameManager.Instance.OnDataLoadedFromPlayFab(loadedData);
                
                // İsim senkronizasyonu
                if (!string.IsNullOrEmpty(displayName)) 
                    GameManager.Instance.playerData.username = displayName;

                Debug.Log("Veriler Yüklendi ve İşlendi 📥");
            }
        }
        else
        {
            Debug.Log("Yeni Hesap veya 'PlayerData' anahtarı yok. Varsayılan verilerle devam.");
            // Yeni hesapsa ve GameManager varsa, eldeki varsayılan veriyi kaydet ki PlayFab'da yer açılsın
            if (GameManager.Instance != null) 
                SaveData(GameManager.Instance.playerData);
        }
    }

    // =================================================================================
    // 3. İSTATİSTİK (STATS)
    // =================================================================================

    public void SendLeaderboardStats(int elo, int level)
    {
        var request = new UpdatePlayerStatisticsRequest
        {
            Statistics = new List<StatisticUpdate>
            {
                new StatisticUpdate { StatisticName = "RankedElo", Value = elo },
                new StatisticUpdate { StatisticName = "PlayerLevel", Value = level }
            }
        };
        PlayFabClientAPI.UpdatePlayerStatistics(request, result => Debug.Log("İstatistikler Gönderildi 📊"), OnError);
    }

    public void GetLeaderboard()
    {
        var request = new GetLeaderboardRequest
        {
            StatisticName = "RankedElo",
            StartPosition = 0,
            MaxResultsCount = 10,
            ProfileConstraints = new PlayerProfileViewConstraints { ShowDisplayName = true }
        };
        
        PlayFabClientAPI.GetLeaderboard(request, result => 
        {
            OnLeaderboardLoaded?.Invoke(result.Leaderboard);
        }, OnError);
    }

    // =================================================================================
    // 4. SOSYAL
    // =================================================================================

    public void AddFriend(string friendPlayFabId)
    {
        var request = new AddFriendRequest { FriendPlayFabId = friendPlayFabId };
        PlayFabClientAPI.AddFriend(request, result => Debug.Log("Arkadaş Eklendi!"), OnError);
    }

    /*public void GetFriends()
    {
        var request = new GetFriendsListRequest { IncludePlayFabId = true, IncludeSteamId = false };
        PlayFabClientAPI.GetFriendsList(request, result => 
        {
            OnFriendsLoaded?.Invoke(result.Friends);
        }, OnError);
    }*/

    void OnError(PlayFabError error)
    {
        Debug.LogError($"PlayFab Hatası: {error.GenerateErrorReport()}");
    }
}


---------------- FILE: SaveManager.cs ----------------
using UnityEngine;
using System.IO;

public static class SaveManager
{
    private static string saveFileName = "savefile.json";

    public static void Save(PlayerData data)
    {
        try
        {
            string json = JsonUtility.ToJson(data, true);
            string path = Path.Combine(Application.persistentDataPath, saveFileName);
            File.WriteAllText(path, json);
            // Debug.Log("Oyun Kaydedildi: " + path);
        }
        catch (System.Exception e)
        {
            Debug.LogError("Kayıt Hatası: " + e.Message);
        }
    }

    public static PlayerData Load()
    {
        string path = Path.Combine(Application.persistentDataPath, saveFileName);
        
        if (File.Exists(path))
        {
            try
            {
                string json = File.ReadAllText(path);
                PlayerData data = JsonUtility.FromJson<PlayerData>(json);
                return data;
            }
            catch (System.Exception e)
            {
                Debug.LogError("Yükleme Hatası (Dosya bozuk olabilir): " + e.Message);
                return new PlayerData(); // Hata varsa yeni dosya aç
            }
        }
        else
        {
            Debug.Log("Kayıt dosyası bulunamadı, yeni oluşturuluyor.");
            return new PlayerData(); // Dosya yoksa sıfırdan oluştur
        }
    }
}


---------------- FILE: SettingsManager.cs ----------------
using UnityEngine;

public class SettingsManager : MonoBehaviour
{
    public static SettingsManager Instance;

    private void Awake()
    {
        // --- KRİTİK AYAR ---
        // Eğer bu script GameManager objesi üzerindeyse (ki öyle olmalı),
        // Sahneler arası yok olmaz.
        if (Instance == null)
        {
            Instance = this;
            // DontDestroyOnLoad(gameObject); // GameManager zaten DDOL ise buna gerek yok
        }
        else
        {
            // Eğer yeni sahnede unutulmuş bir SettingsManager varsa onu yok et
            Destroy(gameObject);
            return;
        }
    }

    public void OpenSettings()
    {
        SettingsUI ui = UIManager.Instance.GetPanel<SettingsUI>();
        
        if (ui != null)
        {
            // 1. Önceki dinleyicileri temizle (Çakışmayı önle)
            ui.musicSlider.onValueChanged.RemoveAllListeners();
            ui.sfxSlider.onValueChanged.RemoveAllListeners();
            ui.closeButton.onClick.RemoveAllListeners();

            // 2. Yeni dinleyicileri ekle
            ui.musicSlider.onValueChanged.AddListener(SetMusicVolume);
            ui.sfxSlider.onValueChanged.AddListener(SetSFXVolume);
            ui.closeButton.onClick.AddListener(CloseSettings);

            // 3. Paneli Aç (OnEnable burada otomatik çalışacak ve veriyi yükleyecek)
            ui.Show();
        }
    }

    public void CloseSettings()
    {
        UIManager.Instance.GetPanel<SettingsUI>().Hide();
        // Ayarlar kapanınca kaydet
        if (GameManager.Instance != null) GameManager.Instance.SaveGame();
    }

    void SetMusicVolume(float value)
    {
        if (GameManager.Instance != null)
        {
            GameManager.Instance.playerData.musicVolume = value;
            // AudioManager.Instance.SetMusic(value);
        }
    }

    void SetSFXVolume(float value)
    {
        if (GameManager.Instance != null)
        {
            GameManager.Instance.playerData.sfxVolume = value;
            // AudioManager.Instance.SetSFX(value);
        }
    }
}


---------------- FILE: UIManager.cs ----------------
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

public class UIManager : MonoBehaviour
{
    public static UIManager Instance;

    // Tüm panelleri tipine göre tutan liste
    private List<BasePanel> allPanels;

    private void Awake()
    {
        // Singleton Yapısı
        if (Instance == null) Instance = this;
        else Destroy(gameObject);

        // Sahnedeki tüm BasePanel türevlerini bul ve listeye ekle
        // (inactive olanları da bulması için true parametresi verdik)
        allPanels = FindObjectsOfType<BasePanel>(true).ToList();

        // Panelleri Başlat
        foreach (var panel in allPanels)
        {
            panel.Init();
            if (panel.startActive) panel.Show();
            else panel.Hide();
        }
    }

    // İstediğimiz paneli türüne göre (Örn: GetPanel<BattleUI>()) getiren fonksiyon
    public T GetPanel<T>() where T : BasePanel
    {
        foreach (var panel in allPanels)
        {
            if (panel is T) return (T)panel;
        }
        Debug.LogError($"Panel bulunamadı: {typeof(T).Name}");
        return null;
    }

    // Bir paneli aç, diğer her şeyi kapat (Opsiyonel kullanım)
    public void ShowPanel<T>() where T : BasePanel
    {
        foreach (var panel in allPanels)
        {
            if (panel is T) panel.Show();
            else panel.Hide();
        }
    }
}


---------------- FILE: FishNetConnectionHandler.cs ----------------
using UnityEngine;
using FishNet.Managing;
using FishNet.Transporting;
using FishNet.Managing.Scened; // Sahne yönetimi

public class FishNetConnectionHandler : MonoBehaviour
{
    public static FishNetConnectionHandler Instance;
    private NetworkManager _networkManager;

    private void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
        }
        else
        {
            Destroy(gameObject);
        }
    }

    private void Start()
    {
        _networkManager = FindObjectOfType<NetworkManager>();
        
        if (_networkManager == null)
            Debug.LogError("FishNetConnectionHandler: Sahnede NetworkManager yok!");
        else
        {
            // Sunucu durumunu dinlemeye başla
            _networkManager.ServerManager.OnServerConnectionState += OnServerConnectionState;
        }
    }

    private void OnDestroy()
    {
        // Dinlemeyi bırak (Hafıza kaçağını önle)
        if (_networkManager != null)
        {
            _networkManager.ServerManager.OnServerConnectionState -= OnServerConnectionState;
        }
    }

    // PlayFabMatchmaker buradan tetikler
    public void StartConnection(bool amIHost)
    {
        if (_networkManager == null) return;

        if (amIHost)
        {
            Debug.Log("<color=green>Rol: HOST - Sunucu Başlatılıyor...</color>");
            // Sadece sunucuyu başlat, sahneyi event içinde yükleyeceğiz
            _networkManager.ServerManager.StartConnection();
            
            // Host aynı zamanda bir Client'tır, kendini de bağla
            _networkManager.ClientManager.StartConnection();
        }
        else
        {
            Debug.Log("<color=yellow>Rol: CLIENT - Sunucuya Bağlanılıyor...</color>");
            // Client direkt bağlanır (IP: localhost varsayılan)
            _networkManager.ClientManager.StartConnection();
        }
    }

    // Sunucu durumu değişince FishNet bu fonksiyonu otomatik çağırır
    private void OnServerConnectionState(ServerConnectionStateArgs args)
    {
        // Eğer sunucu başarıyla başladıysa (Started)
        if (args.ConnectionState == LocalConnectionState.Started)
        {
            Debug.Log("✅ Sunucu Hazır! Sahne Yükleniyor...");
            LoadBattleScene();
        }
    }

    private void LoadBattleScene()
    {
        SceneLoadData sld = new SceneLoadData("BattleScene");
        sld.ReplaceScenes = ReplaceOption.All; // Eski sahneleri kapat
        _networkManager.SceneManager.LoadGlobalScenes(sld);
    }
}


---------------- FILE: NetworkPlayerController.cs ----------------
using UnityEngine;
using FishNet.Object;
using FishNet.Object.Synchronizing;

public class NetworkPlayerController : NetworkBehaviour
{
    // SyncVar: Sunucudan herkese yayılan veri
    public readonly SyncVar<float> _currentHealth = new SyncVar<float>(1000f);
    public readonly SyncVar<float> _maxHealth = new SyncVar<float>(1000f);
    public readonly SyncVar<string> _playerName = new SyncVar<string>("Player");

    public float currentHealth { get => _currentHealth.Value; set => _currentHealth.Value = value; }
    public float maxHealth { get => _maxHealth.Value; set => _maxHealth.Value = value; }
    public string playerName { get => _playerName.Value; set => _playerName.Value = value; }

    private void Awake()
    {
        _currentHealth.OnChange += OnHealthChanged;
    }

    private void OnDestroy()
    {
        _currentHealth.OnChange -= OnHealthChanged;
    }

    public override void OnStartClient()
    {
        base.OnStartClient();

        if (base.IsOwner)
        {
            name = "Local_NetworkPlayer";
            if (BattleManager.Instance != null) BattleManager.Instance.RegisterNetworkPlayer(this, true);
        }
        else
        {
            name = "Remote_NetworkPlayer";
            if (BattleManager.Instance != null) BattleManager.Instance.RegisterNetworkPlayer(this, false);
        }
        
        UpdateUI();
    }

    // --- YENİ: Sunucu Tarafından Statları Ayarla ---
    // Bunu BattleManager çağıracak
    public void SetStatsServer(float maxHP, string pName)
    {
        // Sadece sunucu SyncVar değiştirebilir
        if (!base.IsServer) return;

        maxHealth = maxHP;
        currentHealth = maxHP; // Canı fulle
        playerName = pName;
        
        // Debug.Log($"[Server] Statlar Ayarlandı: {pName} - HP: {maxHP}");
    }
    // ----------------------------------------------

    [ServerRpc(RequireOwnership = false)]
    public void TakeDamageServer(float amount)
    {
        float newVal = currentHealth - amount;
        if (newVal < 0) newVal = 0;
        currentHealth = newVal;
    }

    private void OnHealthChanged(float prev, float next, bool asServer)
    {
        UpdateUI();
    }

    private void UpdateUI()
    {
        if (BattleManager.Instance != null)
        {
            BattleManager.Instance.UpdateNetworkUI(base.IsOwner, currentHealth, maxHealth);
        }
    }
}


---------------- FILE: PlayFabMatchmaker.cs ----------------
using UnityEngine;
using PlayFab;
using PlayFab.MultiplayerModels;
using PlayFab.Json; 
using System.Collections;
using System.Collections.Generic;

public class PlayFabMatchmaker : MonoBehaviour
{
    [Header("Referanslar")]
    public MatchFindingUI uiController;

    private string ticketId;
    private Coroutine pollTicketCoroutine;
    private bool isMatchFound = false;
    
    // Timeout Ayarı
    private float matchTimeout = 120f; 
    private float currentTimer = 0f;
    private string[] botNames = { "DragonSlayer", "ShadowHunter", "ProGamer99", "KnightX" };

    private void Start()
    {
        if (PlayFabClientAPI.IsClientLoggedIn()) StartMatchmaking();
        else Debug.LogError("PlayFab Girişi Yapılmamış!");
    }

    public void StartMatchmaking()
    {
        Debug.Log("Maç Bileti Oluşturuluyor...");
        currentTimer = 0f;
        isMatchFound = false;

        PlayerData pData = GameManager.Instance.playerData;
        GameMode mode = GameManager.Instance.currentMode;
        CharacterData myChar = GameManager.Instance.selectedCharacter;

        // UI Güncelle
        uiController.SetLocalPlayerInfo(pData, myChar);

        if (mode == GameMode.Practice)
        {
            StartCoroutine(FakeMatchRoutine(1f));
            return;
        }

        // --- DÜZELTME: İSİM VE KARAKTER BİLGİSİNİ DE GÖNDERİYORUZ ---
        MatchmakingPlayerAttributes attributes = new MatchmakingPlayerAttributes();
        var dataDictionary = new Dictionary<string, object>();
        
        dataDictionary.Add("Elo", pData.elo);
        dataDictionary.Add("Level", pData.level);
        // Karşı taraf ismimizi ve karakterimizi görsün diye bunları da ekliyoruz:
        dataDictionary.Add("Name", pData.username); 
        dataDictionary.Add("CharName", myChar != null ? myChar.characterName : "Warrior");
        
        dataDictionary.Add("AvatarId", pData.avatarId);
        dataDictionary.Add("FrameId", pData.frameId);

        attributes.DataObject = dataDictionary;
        // -----------------------------------------------------------

        string queueName = (mode == GameMode.Ranked) ? "RankedQueue" : "CasualQueue";

        PlayFabMultiplayerAPI.CreateMatchmakingTicket(
            new CreateMatchmakingTicketRequest
            {
                Creator = new MatchmakingPlayer
                {
                    Entity = new EntityKey
                    {
                        Id = PlayFabSettings.staticPlayer.EntityId,
                        Type = PlayFabSettings.staticPlayer.EntityType
                    },
                    Attributes = attributes
                },
                GiveUpAfterSeconds = (int)matchTimeout, 
                QueueName = queueName
            },
            OnTicketCreated,
            OnMatchmakingError
        );
    }

    private void OnTicketCreated(CreateMatchmakingTicketResult result)
    {
        ticketId = result.TicketId;
        pollTicketCoroutine = StartCoroutine(PollTicketStatus());
    }

    private IEnumerator PollTicketStatus()
    {
        while (!isMatchFound)
        {
            currentTimer += 6.0f;
            if (currentTimer >= matchTimeout)
            {
                CancelTicketAndStartFakeMatch();
                yield break;
            }

            yield return new WaitForSeconds(6.0f);

            PlayFabMultiplayerAPI.GetMatchmakingTicket(
                new GetMatchmakingTicketRequest
                {
                    TicketId = ticketId,
                    QueueName = GameManager.Instance.currentMode == GameMode.Ranked ? "RankedQueue" : "CasualQueue"
                },
                OnTicketStatusReceived,
                OnMatchmakingError
            );
        }
    }

    private void OnTicketStatusReceived(GetMatchmakingTicketResult result)
    {
        if (result.Status == "Matched")
        {
            isMatchFound = true;
            StopCoroutine(pollTicketCoroutine);
            GetMatchDetails(result.MatchId);
        }
        else if (result.Status == "Canceled")
        {
            if (!isMatchFound) CancelTicketAndStartFakeMatch();
        }
    }

    private void CancelTicketAndStartFakeMatch()
    {
        isMatchFound = true;
        if (pollTicketCoroutine != null) StopCoroutine(pollTicketCoroutine);

        if (!string.IsNullOrEmpty(ticketId))
        {
            PlayFabMultiplayerAPI.CancelMatchmakingTicket(
                new CancelMatchmakingTicketRequest
                {
                    TicketId = ticketId,
                    QueueName = GameManager.Instance.currentMode == GameMode.Ranked ? "RankedQueue" : "CasualQueue"
                }, null, null);
        }
        StartCoroutine(FakeMatchRoutine(0.5f));
    }

    private IEnumerator FakeMatchRoutine(float delay)
    {
        yield return new WaitForSeconds(delay);
        PlayerData pData = GameManager.Instance.playerData;
        
        // Rastgele Bot
        string fName = botNames[Random.Range(0, botNames.Length)];
        int fElo = Mathf.Clamp(pData.elo + Random.Range(-50, 50), 0, 9999);
        int fLevel = Mathf.Clamp(pData.level + Random.Range(-2, 3), 1, 99);
        CharacterData fChar = null;
        if (GameManager.Instance.allCharacters.Count > 0)
            fChar = GameManager.Instance.allCharacters[Random.Range(0, GameManager.Instance.allCharacters.Count)];
        int fAvatarId = Random.Range(0, GameManager.Instance.avatarList.Count);
        int fFrameId = Random.Range(0, GameManager.Instance.frameList.Count);

        GameManager.Instance.isFakeBotMatch = true;
        
        // SetMatchOpponent ARTIK YENİ PARAMETRELERİ ALIYOR
        GameManager.Instance.SetMatchOpponent(fName, fElo, fLevel, fChar != null ? fChar.characterName : "Warrior", fAvatarId, fFrameId);

        uiController.SetEnemyInfo(fName, fElo, fLevel, fChar != null ? fChar.characterName : "Unknown", fAvatarId, fFrameId);
        StartCoroutine(uiController.StartCountdownRoutine(StartGameScene));
    }

    private void GetMatchDetails(string matchId)
    {
        PlayFabMultiplayerAPI.GetMatch(
            new GetMatchRequest
            {
                MatchId = matchId,
                QueueName = GameManager.Instance.currentMode == GameMode.Ranked ? "RankedQueue" : "CasualQueue",
                ReturnMemberAttributes = true, 
                EscapeObject = false 
            },
            OnMatchDetailsReceived,
            OnMatchmakingError
        );
    }

    private void OnMatchDetailsReceived(GetMatchResult result)
    {
        string myEntityId = PlayFabSettings.staticPlayer.EntityId;
        MatchmakingPlayerWithTeamAssignment enemy = null;

        foreach (var member in result.Members)
        {
            if (member.Entity.Id != myEntityId) { enemy = member; break; }
        }

        if (enemy != null)
        {
            int eElo = 0; int eLevel = 0; int eAvatar = 0; int eFrame = 0;
            string eName = "Enemy"; string eChar = "Warrior";

            if (enemy.Attributes != null && enemy.Attributes.DataObject != null)
            {
                var data = (JsonObject)enemy.Attributes.DataObject;
                
                if (data.ContainsKey("Elo")) eElo = int.Parse(data["Elo"].ToString());
                if (data.ContainsKey("Level")) eLevel = int.Parse(data["Level"].ToString());
                if (data.ContainsKey("Name")) eName = data["Name"].ToString();
                if (data.ContainsKey("CharName")) eChar = data["CharName"].ToString();
                
                // YENİLERİ OKU
                if (data.ContainsKey("AvatarId")) eAvatar = int.Parse(data["AvatarId"].ToString());
                if (data.ContainsKey("FrameId")) eFrame = int.Parse(data["FrameId"].ToString());
            }

            GameManager.Instance.isFakeBotMatch = false;
            
            // Veriyi GameManager'a taşı
            GameManager.Instance.SetMatchOpponent(eName, eElo, eLevel, eChar, eAvatar, eFrame);

            // UI Güncelle
            uiController.SetEnemyInfo(eName, eElo, eLevel, eChar, eAvatar, eFrame);
            StartCoroutine(uiController.StartCountdownRoutine(StartGameScene));
        }
    }

    private void StartGameScene()
    {
        if (GameManager.Instance.isFakeBotMatch)
        {
            UnityEngine.SceneManagement.SceneManager.LoadScene("BattleScene");
        }
        else
        {
            ConnectNetwork();
        }
    }

    private void ConnectNetwork()
    {
        bool amIHost = false;
#if UNITY_EDITOR
        if (ParrelSync.ClonesManager.IsClone()) amIHost = false; else amIHost = true;
#else
        amIHost = false;
#endif
        if (FishNetConnectionHandler.Instance != null) FishNetConnectionHandler.Instance.StartConnection(amIHost);
    }

    private void OnMatchmakingError(PlayFabError error)
    {
        if (error.Error == PlayFabErrorCode.MatchmakingTicketMembershipLimitExceeded) return;
        Debug.LogError($"PlayFab Hatası: {error.GenerateErrorReport()}");
    }

    private void OnDestroy()
    {
        if (!isMatchFound && !string.IsNullOrEmpty(ticketId))
        {
            PlayFabMultiplayerAPI.CancelMatchmakingTicket(new CancelMatchmakingTicketRequest
            {
                TicketId = ticketId,
                QueueName = GameManager.Instance.currentMode == GameMode.Ranked ? "RankedQueue" : "CasualQueue"
            }, null, null);
        }
    }
}


---------------- FILE: DamageSkill.cs ----------------
using UnityEngine;

[CreateAssetMenu(menuName = "Playful/Skills/Damage Skill")]
public class DamageSkill : SkillData
{
    public float damageAmount = 200f;
    public GameObject effectPrefab; // Görsel efekt (Opsiyonel)

    public override void Trigger(BattleManager bm, EnemyManager em, bool isPlayer)
    {
        // Yeteneği kullanan Player ise -> Rakip hasar alır (EnemyAttack = false)
        // Yeteneği kullanan Rakip ise -> Player hasar alır (EnemyAttack = true)
        bool targetIsPlayer = !isPlayer; 
        
        bm.TakeDamage(targetIsPlayer, damageAmount);
        Debug.Log($"{skillName} kullanıldı! Hasar: {damageAmount}");
        
        // İleride buraya efekt oynatma kodu da eklenebilir
    }
}


---------------- FILE: HealSkill.cs ----------------
using UnityEngine;

[CreateAssetMenu(menuName = "Playful/Skills/Heal Skill")]
public class HealSkill : SkillData
{
    public float healAmount = 150f;

    public override void Trigger(BattleManager bm, EnemyManager em, bool isPlayer)
    {
        bm.Heal(isPlayer, healAmount); // BattleManager'a Heal fonksiyonu ekleyeceğiz
        Debug.Log($"{skillName} kullanıldı! İyileşme: {healAmount}");
    }
}


---------------- FILE: BasePanel.cs ----------------
using UnityEngine;

// Abstract class: Tek başına kullanılamaz, miras alınması gerekir.
public abstract class BasePanel : MonoBehaviour
{
    public bool startActive = false; // Oyun başlayınca açık mı olsun?

    public virtual void Init()
    {
        // Başlangıç ayarları (Gerekirse override edilebilir)
    }

    public virtual void Show()
    {
        gameObject.SetActive(true);
    }

    public virtual void Hide()
    {
        gameObject.SetActive(false);
    }
}


---------------- FILE: BattleUI.cs ----------------
using UnityEngine;
using UnityEngine.UI; // Slider ve Image için şart!
using TMPro;

public class BattleUI : BasePanel
{
    [Header("Bar Referansları")]
    public Slider battleSlider; // Çakışmayı önlemek için tam adını yazdım
    public TextMeshProUGUI playerHealthText;
    public TextMeshProUGUI enemyHealthText;
    public GameObject playerShieldIcon;
    public GameObject enemyShieldIcon;
    
    [Header("Profil Görselleri")]
    public Image playerAvatar;
    public Image playerFrame;
    public Image enemyAvatar;
    public Image enemyFrame;

    [Header("Mana & Skill")]
    public Image manaBarFill;
    public Button skillButton;

    [Header("Zamanlayıcı")]
    public TextMeshProUGUI timerText;

    [Header("Efektler")]
    public ObjectShake cameraShaker;

    // Tekli güncellemeler için son değerleri hafızada tutuyoruz
    private float _cachedPlayerHP;
    private float _cachedEnemyHP;

    public override void Init()
    {
        // Başlangıçta kalkanları gizle
        if (playerShieldIcon) playerShieldIcon.SetActive(false);
        if (enemyShieldIcon) enemyShieldIcon.SetActive(false);
        if (skillButton) skillButton.interactable = false;
        
        // Shake referansı yoksa otomatik bul
        if (cameraShaker == null) cameraShaker = GetComponent<ObjectShake>();
    }
    
    public void SetAvatars(Sprite pAvatar, Sprite pFrame, Sprite eAvatar, Sprite eFrame)
    {
        if(playerAvatar) playerAvatar.sprite = pAvatar;
        if(playerFrame) playerFrame.sprite = pFrame;
        if(enemyAvatar) enemyAvatar.sprite = eAvatar;
        if(enemyFrame) enemyFrame.sprite = eFrame;
    }

    // --- ESKİ FONKSİYON (Geriye uyumluluk için) ---
    public void UpdateBattleBars(float currentHP, float maxHP, float enemyHP, float maxEnemyHP)
    {
        _cachedPlayerHP = currentHP;
        _cachedEnemyHP = enemyHP;
        RefreshVisuals();
    }

    // Sadece Oyuncu (Sol) Güncellenince
    public void UpdatePlayerBarOnly(float current, float max)
    {
        _cachedPlayerHP = current;
        RefreshVisuals();
    }

    // Sadece Rakip (Sağ) Güncellenince
    public void UpdateEnemyBarOnly(float current, float max)
    {
        _cachedEnemyHP = current;
        RefreshVisuals();
    }

    // Ortak Görsel Güncelleme Mantığı
    private void RefreshVisuals()
    {
        // 1. Yazıları Güncelle
        if (playerHealthText != null) playerHealthText.text = Mathf.FloorToInt(_cachedPlayerHP).ToString();
        if (enemyHealthText != null) enemyHealthText.text = Mathf.FloorToInt(_cachedEnemyHP).ToString();

        // 2. Slider'ı Güncelle
        // Önce Slider bağlı mı diye kontrol et (Hata vermemesi için)
        if (battleSlider != null)
        {
            float totalHealth = _cachedPlayerHP + _cachedEnemyHP;
            
            if (totalHealth > 0)
            {
                float ratio = _cachedPlayerHP / totalHealth;
                
                // DÜZELTME: 100f yerine Slider'ın kendi MaxValue değerini kullanıyoruz.
                // Eğer Inspector'da MaxValue 1 ise 1 ile, 100 ise 100 ile çarpar.
                battleSlider.value = ratio * battleSlider.maxValue; 
            }
            else
            {
                battleSlider.value = 0; // Herkes öldüyse
            }
        }
        else
        {
            // Eğer buraya düşüyorsa Inspector'dan Slider'ı tekrar sürükle!
            Debug.LogError("BattleUI: Battle Slider Inspector'da bağlı değil!");
        }
    }

    // --- DİĞER FONKSİYONLAR ---

    public void UpdateMana(float currentMana, float maxMana)
    {
        if (manaBarFill != null) manaBarFill.fillAmount = currentMana / maxMana;
        if (skillButton != null) skillButton.interactable = (currentMana >= maxMana);
    }

    public void SetPlayerShield(bool isActive)
    {
        if (playerShieldIcon) playerShieldIcon.SetActive(isActive);
    }

    public void UpdateTimer(float timeRemaining)
    {
        int minutes = Mathf.FloorToInt(timeRemaining / 60F);
        int seconds = Mathf.FloorToInt(timeRemaining % 60F);
        if (timerText) timerText.text = string.Format("{0:00}:{1:00}", minutes, seconds);
    }

    public void ShakeScreen(float duration, float magnitude)
    {
        if (cameraShaker) cameraShaker.Shake(duration, magnitude);
    }
}


---------------- FILE: EndGameUI.cs ----------------
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class EndGameUI : BasePanel
{
    [Header("Sonuç Göstergeleri")]
    public GameObject victoryIcon;
    public GameObject defeatIcon;
    public GameObject backgroundFrame; // Renk değişimi için (Opsiyonel)

    [Header("Elo Info Panel")]
    public GameObject eloInfoPanel;
    public TextMeshProUGUI currentEloText;
    public Slider rankSlider;
    public Image currentRankIcon;
    public Image nextRankIcon;
    
    [Header("Level Info")]
    public TextMeshProUGUI levelText;
    public Image levelRadialFill; // Level XP barı

    [Header("Statistics Panel")]
    public GameObject statisticsPanel;
    public TextMeshProUGUI damageText;
    public TextMeshProUGUI comboText;
    public TextMeshProUGUI timeText;
    public TextMeshProUGUI hpText;

    [Header("Butonlar")]
    public Button statisticButton; // Stats açar
    public Button eloStatsButton;  // Elo açar
    public Button rematchButton;
    public Button mainMenuButton;

    public override void Init()
    {
        // Buton Dinleyicileri
        statisticButton.onClick.AddListener(ShowStatistics);
        eloStatsButton.onClick.AddListener(ShowEloInfo);
        
        // Başlangıçta Elo Panel açık, Stats kapalı
        ShowEloInfo();
    }

    public void ShowEloInfo()
    {
        eloInfoPanel.SetActive(true);
        statisticsPanel.SetActive(false);
        
        eloStatsButton.gameObject.SetActive(false); // Kendi butonunu gizle
        statisticButton.gameObject.SetActive(true); // Diğer butonu göster
    }

    public void ShowStatistics()
    {
        eloInfoPanel.SetActive(false);
        statisticsPanel.SetActive(true);

        statisticButton.gameObject.SetActive(false);
        eloStatsButton.gameObject.SetActive(true);
    }

    // Dataları Ekrana Basma Fonksiyonları
    public void SetVictoryStatus(bool isVictory)
    {
        if (victoryIcon) victoryIcon.SetActive(isVictory);
        if (defeatIcon) defeatIcon.SetActive(!isVictory);
    }

    public void SetEloVisuals(int elo, int change, Sprite rankImg, Sprite nextRankImg, float sliderVal)
    {
        // "+25" veya "-15" formatında yaz
        string sign = change >= 0 ? "+" : "";
        currentEloText.text = $"ELO: {sign}{change}"; 
        currentEloText.color = change >= 0 ? Color.green : Color.red;

        currentRankIcon.sprite = rankImg;
        nextRankIcon.sprite = nextRankImg;
        rankSlider.value = sliderVal;
    }

    public void SetLevelVisuals(int level, float xpProgress)
    {
        levelText.text = level.ToString();
        levelRadialFill.fillAmount = xpProgress;
    }

    public void SetStats(float damage, int combo, float time, float hp)
    {
        damageText.text = Mathf.FloorToInt(damage).ToString();
        comboText.text = combo.ToString() + "x";
        
        int min = Mathf.FloorToInt(time / 60);
        int sec = Mathf.FloorToInt(time % 60);
        timeText.text = $"{min:00}:{sec:00}";
        
        hpText.text = Mathf.FloorToInt(hp).ToString();
    }
}


---------------- FILE: GameModeUI.cs ----------------
using UnityEngine;
using UnityEngine.UI;

public class GameModeUI : BasePanel
{
    [Header("Mod Butonları")]
    public Button rankedButton;
    public Button casualButton;
    public Button practiceButton;
    // FriendMatch butonu Arkadaş Listesi pencresinde olacak

    [Header("Diğer")]
    public Button closeButton; // Paneli kapatır

    public override void Init()
    {
        base.Init();
    }
}


---------------- FILE: HeroesUI.cs ----------------
using System;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

// Bu script SADECE Karakter Seçim/Satın Alma Panelini yönetir.
public class HeroesUI : BasePanel
{
    [Header("Navigasyon")]
    public Button backButton; // Lobby'e dönen buton (<)
    public Button nextButton; // Sonraki Karakter (>)
    public Button prevButton; // Önceki Karakter (<)

    [Header("Karakter Bilgileri")]
    public Image characterAvatar;       // Ortadaki büyük resim
    public TextMeshProUGUI nameText;    // "Warrior"
    public TextMeshProUGUI classText;   // "Melee / Tank"
    public TextMeshProUGUI descText;    // Yetenek açıklaması

    [Header("İstatistik Barları")]
    public Slider healthBar;
    public Slider manaBar;
    public Slider damageBar;

    [Header("Aksiyon Butonları")]
    public Button equipButton;          // "SEÇ" veya "SEÇİLDİ" butonu
    public TextMeshProUGUI equipText;   // Butonun üzerindeki yazı
    
    [Header("Satın Alma Paneli")]
    public GameObject buyPanel;         // Kilitliyse açılacak panel
    public Button buyGoldButton;        // Altınla Al
    public TextMeshProUGUI goldPriceText;
    public Button buyGemButton;         // Elmasla Al
    public TextMeshProUGUI gemPriceText;

    public override void Init()
    {
        base.Init();
        // Buton dinleyicilerini Manager atayacak
    }

    private void Start()
    {
        
    }

    // Ekranı Verilerle Doldur
    public void UpdateVisuals(CharacterData charData, PlayerData playerData, bool isUnlocked, bool isEquipped)
    {
        // 1. Temel Bilgiler
        characterAvatar.sprite = charData.avatar;
        nameText.text = charData.characterName;
        classText.text = charData.className;
        
        if (charData.activeSkill != null)
            descText.text = $"<color=yellow>{charData.activeSkill.skillName}:</color> {charData.activeSkill.description}";
        else
            descText.text = "Özel yetenek yok.";

        // 2. İstatistikler (Değerleri normalize et)
        healthBar.value = charData.maxHealth / 2000f; 
        manaBar.value = charData.maxMana / 200f;
        damageBar.value = charData.baseAttackDamage / 100f;

        // 4. Kilit / Satın Alma Mantığı
        if (isUnlocked)
        {
            buyPanel.SetActive(false);
            equipButton.gameObject.SetActive(true);

            if (isEquipped)
            {
                equipButton.interactable = false; // Zaten seçili, tekrar basılamasın
                equipText.text = "SEÇİLDİ";
                equipText.color = Color.green;
            }
            else
            {
                equipButton.interactable = true;
                equipText.text = "SEÇ";
                equipText.color = Color.white;
            }
        }
        else
        {
            // Karakter Kilitli
            equipButton.gameObject.SetActive(false);
            buyPanel.SetActive(true);

            goldPriceText.text = charData.goldPrice.ToString();
            gemPriceText.text = charData.gemPrice.ToString();

            // Paran yetmiyorsa buton sönük olsun
            buyGoldButton.interactable = (playerData.gold >= charData.goldPrice);
            buyGemButton.interactable = (playerData.gems >= charData.gemPrice);
        }
    }
}


---------------- FILE: InGameMenuUI.cs ----------------
using UnityEngine;
using UnityEngine.UI;

public class InGameMenuUI : BasePanel
{
    [Header("Butonlar")]
    public Button resumeButton;    // Oyuna dön
    public Button settingsButton;  // Ayarları aç
    public Button surrenderButton; // Teslim Ol
    
    // Bu panel açıldığında oyun durmaz!
}


---------------- FILE: LeaderboardRowUI.cs ----------------
using UnityEngine;
using TMPro;

public class LeaderboardRowUI : MonoBehaviour
{
    public TextMeshProUGUI rankText;  // 1., 2., 3.
    public TextMeshProUGUI nameText;  // DragonSlayer
    public TextMeshProUGUI scoreText; // 1500 Elo

    public void Setup(int rank, string playerName, int score)
    {
        rankText.text = (rank + 1).ToString() + ".";
        nameText.text = string.IsNullOrEmpty(playerName) ? "Unknown Warrior" : playerName;
        scoreText.text = score.ToString();
        
        // İstersen: İlk 3 kişiyi altın/gümüş/bronz renk yapabilirsin
        if (rank == 0) rankText.color = Color.yellow;
    }
}


---------------- FILE: LeaderboardUI.cs ----------------
using UnityEngine;
using UnityEngine.UI;
using System.Collections.Generic;
using PlayFab.ClientModels;
using TMPro;

public class LeaderboardUI : BasePanel
{
    [Header("Referanslar")]
    public Transform contentParent; // Scroll View'in "Content" objesi
    public GameObject rowPrefab;    // Az önce yaptığımız satır prefabı
    public Button closeButton;

    [Header("Durum")]
    public TextMeshProUGUI statusText; // "Yükleniyor..." yazısı için

    public override void Init()
    {
        base.Init();
        closeButton.onClick.AddListener(Hide);
    }

    private void OnEnable()
    {
        // Panel açılınca PlayFabManager'ı dinlemeye başla
        PlayFabManager.OnLeaderboardLoaded += UpdateUI;
        
        // Veriyi iste
        statusText.text = "Sıralama Yükleniyor...";
        statusText.gameObject.SetActive(true);
        
        // Mevcut listeyi temizle
        foreach (Transform child in contentParent) Destroy(child.gameObject);

        // İsteği gönder
        if (PlayFabManager.Instance != null)
            PlayFabManager.Instance.GetLeaderboard();
    }

    private void OnDisable()
    {
        // Panel kapanınca dinlemeyi bırak (Hata vermemesi için)
        PlayFabManager.OnLeaderboardLoaded -= UpdateUI;
    }

    void UpdateUI(List<PlayerLeaderboardEntry> leaderboard)
    {
        statusText.gameObject.SetActive(false); // Yükleniyor yazısını gizle

        foreach (var entry in leaderboard)
        {
            // Yeni satır oluştur
            GameObject newRow = Instantiate(rowPrefab, contentParent);
            
            // Veriyi içine doldur
            LeaderboardRowUI rowScript = newRow.GetComponent<LeaderboardRowUI>();
            rowScript.Setup(entry.Position, entry.DisplayName, entry.StatValue);
        }
    }
}


---------------- FILE: LobbyUI.cs ----------------
using System;
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class LobbyUI : BasePanel
{
    [Header("Üst Bar")]
    public Image avatarImage;
    public Image profileFrameImage;
    public TextMeshProUGUI playerNameText;
    public TextMeshProUGUI levelText;
    public Slider xpSlider;
    public TextMeshProUGUI goldText;
    public TextMeshProUGUI gemText;
    public Button settingsButton;

    [Header("Orta Alan")]
    public Image currentCharacterDisplay;
    public Button playButton;             // SAVAŞ Butonu
    public Button gameModeButton;         // Mod Seçim Butonu (Ranked/Casual yazan)
    public TextMeshProUGUI currentModeText;
    
    [Header("Oyuncu Cüzdanı (Referans)")]
    public TextMeshProUGUI playerGoldText;
    public TextMeshProUGUI playerGemText;
    
    [Header("Panels")]
    public GameObject userProfileUI;
    
    [Header("Alt Bar & Diğerleri")]
    public Button heroesButton;      
    public Button socialButton;      // BU ARTIK "ARKADAŞLAR" BUTONU
    public Button leaderboardButton; // (YENİ) BU "SIRALAMA" BUTONU
    public Button shopButton;        
    public Button questsButton;      // (YENİ) Görevler butonu varsa ekleyebilirsin
    public Button profileButton;
    
    public override void Init()
    {
        base.Init();
    }

    private void Start()
    {
        
        // Karakterler Butonu -> Lobby kapanır, Karakter menüsü açılır
        heroesButton.onClick.RemoveAllListeners();
        heroesButton.onClick.AddListener(GoToHeroes);

        // Sosyal ve Leaderboard
        socialButton.onClick.RemoveAllListeners();
        socialButton.onClick.AddListener(() => Debug.Log("Arkadaş Listesi (Yakında)"));
        
        profileButton.onClick.RemoveAllListeners();
        profileButton.onClick.AddListener(OpenProfilePanel);
            
            

        if (leaderboardButton != null)
        {
            leaderboardButton.onClick.RemoveAllListeners();
            leaderboardButton.onClick.AddListener(MainMenuManager.Instance.OpenLeaderboardOverlay);
        }
    }

    public void UpdateVisuals(PlayerData data, CharacterData selectedChar, GameMode mode)
    {
        // 1. Profil
        playerNameText.text = string.IsNullOrEmpty(data.username) ? "Player" : data.username;
        levelText.text = "Lvl " + data.level;
        xpSlider.value = (float)data.currentXP / data.requiredXP;
        avatarImage.sprite = GameManager.Instance.GetAvatarSprite(data.avatarId);
        profileFrameImage.sprite = GameManager.Instance.GetFrameSprite(data.frameId);
        
        // 2. Cüzdan
        goldText.text = data.gold.ToString();
        gemText.text = data.gems.ToString();

        // 3. Karakter
        if (selectedChar != null)
            currentCharacterDisplay.sprite = selectedChar.avatar;
        
        // 4. Cüzdanı Güncelle
        playerGoldText.text = data.gold.ToString();
        playerGemText.text = data.gems.ToString();

        // 5. Mod Yazısı (Seçilen moda göre güncellenir)
        currentModeText.text = "" + mode;
    }
    
    public void GoToLobby()
    {
        UIManager.Instance.GetPanel<HeroesUI>().Hide();
        UIManager.Instance.GetPanel<LobbyUI>().Show();
        MainMenuManager.Instance.UpdateAllPanels();
    }

    public void GoToHeroes()
    {
        UIManager.Instance.GetPanel<LobbyUI>().Hide();
        UIManager.Instance.GetPanel<HeroesUI>().Show();
        MainMenuManager.Instance.UpdateAllPanels();
    }

    public void OpenProfilePanel()
    {
        userProfileUI.SetActive(true);
    }
}


---------------- FILE: MatchFindingUI.cs ----------------
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections;
using System.Collections.Generic;

public class MatchFindingUI : MonoBehaviour
{
    [Header("Sol Panel (Biz)")]
    public Image localAvatar;
    public Image localFrame;
    public TextMeshProUGUI localNameText;
    public TextMeshProUGUI localEloText;
    public TextMeshProUGUI localLevelText;
    public Image localCharImage; // Karakter Resmi
    public TextMeshProUGUI localCharNameText;

    [Header("Sağ Panel (Rakip)")]
    public GameObject enemySearchingGroup; 
    public GameObject enemyInfoGroup;      
    public Image enemyAvatar;
    public Image enemyFrame;
    public TextMeshProUGUI enemyNameText;
    public TextMeshProUGUI enemyEloText;
    public TextMeshProUGUI enemyLevelText;
    public Image enemyCharImage; // Rakip Karakter Resmi
    public TextMeshProUGUI enemyCharNameText;

    [Header("Genel")]
    public TextMeshProUGUI countdownText; 
    public Button cancelButton;

    private void Start()
    {
        ResetUI();
    }

    public void ResetUI()
    {
        enemyInfoGroup.SetActive(false);     
        enemySearchingGroup.SetActive(true);
        countdownText.gameObject.SetActive(false); 
    }

    public void SetLocalPlayerInfo(PlayerData pData, CharacterData cData)
    {
        localNameText.text = pData.username;
        localEloText.text = $"Elo: {pData.elo}";
        localLevelText.text = $"Lvl {pData.level}";
        localAvatar.sprite = GameManager.Instance.GetAvatarSprite(pData.avatarId);
        localFrame.sprite = GameManager.Instance.GetFrameSprite(pData.frameId);
        
        if (cData != null)
        {
            localCharImage.sprite = cData.avatar;
            localCharNameText.text = cData.characterName;
            
            // HATALI KOD SİLİNDİ: localAvatar.sprite = cData.avatar; YAPMIYORUZ.
            // Eğer User Profile resmin varsa buraya ayrıca eklersin.
        }
    }

    public void SetEnemyInfo(string name, int elo, int level, string charName, int avatarId, int frameId)
    {
        enemySearchingGroup.SetActive(false);
        enemyInfoGroup.SetActive(true);

        enemyNameText.text = name;
        enemyEloText.text = $"Elo: {elo}";
        enemyLevelText.text = $"Lvl {level}";
        enemyCharNameText.text = charName;
        
        enemyAvatar.sprite = GameManager.Instance.GetAvatarSprite(avatarId);
        enemyFrame.sprite = GameManager.Instance.GetFrameSprite(frameId);

        // Rakip karakter resmini bul
        if (GameManager.Instance != null && GameManager.Instance.allCharacters != null)
        {
            CharacterData foundChar = GameManager.Instance.allCharacters.Find(x => x.characterName == charName);
            
            if (foundChar != null)
            {
                if (enemyCharImage != null) enemyCharImage.sprite = foundChar.avatar;
                // HATALI KOD SİLİNDİ: enemyAvatar'a karakter resmi koymuyoruz.
            }
        }
    }

    public IEnumerator StartCountdownRoutine(System.Action onComplete)
    {
        countdownText.gameObject.SetActive(true);
        cancelButton.gameObject.SetActive(false);

        for (int i = 3; i > 0; i--)
        {
            countdownText.text = i.ToString();
            yield return new WaitForSeconds(1f);
        }

        countdownText.text = "SAVAŞ!";
        yield return new WaitForSeconds(0.5f);
        onComplete?.Invoke();
    }
}


---------------- FILE: SettingsUI.cs ----------------
using UnityEngine;
using UnityEngine.UI;

public class SettingsUI : BasePanel
{
    [Header("Ses Ayarları")]
    public Slider musicSlider;
    public Slider sfxSlider;
    
    [Header("Butonlar")]
    public Button closeButton; 

    // --- BU KISIM EKLENDİ (SİHİRLİ DOKUNUŞ) ---
    private void OnEnable()
    {
        // Panel her açıldığında (SetActive true olunca) burası çalışır
        if (GameManager.Instance != null)
        {
            float musicVol = GameManager.Instance.playerData.musicVolume;
            float sfxVol = GameManager.Instance.playerData.sfxVolume;
            
            // Sliderları güncelle ama Listener'ları tetikleme!
            // (Yoksa sonsuz döngüye girip sesi bozabilir)
            musicSlider.SetValueWithoutNotify(musicVol);
            sfxSlider.SetValueWithoutNotify(sfxVol);
        }
    }
    // -------------------------------------------

    public override void Init()
    {
        base.Init();
    }
    
    public void UpdateVisuals(float musicVol, float sfxVol)
    {
        // Manager'dan manuel çağırmak istersek diye kalsın
        musicSlider.value = musicVol;
        sfxSlider.value = sfxVol;
    }
}


---------------- FILE: UserProfileUI.cs ----------------
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class UserProfileUI : MonoBehaviour
{
    [Header("UI Referansları")]
    public TMP_InputField nameInputField;
    
    // Önizleme resimleri SİLİNDİ.

    [Header("Grid Ayarları")]
    public Transform avatarGridContent; 
    public Transform frameGridContent;
    
    [Header("Prefablar")]
    public GameObject avatarGroupPrefab; // Senin yaptığın 1. Prefab (Avatar Group)
    public GameObject frameGroupPrefab;  // Senin yaptığın 2. Prefab (Frame Group)

    // --- BUTON LİSTELERİ ---
    private List<GameObject> avatarButtons = new List<GameObject>();
    private List<GameObject> frameButtons = new List<GameObject>();

    // Geçici Seçimler
    private int selectedAvatarId;
    private int selectedFrameId;

    private void OnEnable()
    {
        LoadCurrentValues();
        GenerateGrids();
    }

    void LoadCurrentValues()
    {
        PlayerData data = GameManager.Instance.playerData;
        nameInputField.text = data.username;
        selectedAvatarId = data.avatarId;
        selectedFrameId = data.frameId;
    }

    void GenerateGrids()
    {
        // 1. Öncekileri Temizle
        foreach (Transform child in avatarGridContent) Destroy(child.gameObject);
        foreach (Transform child in frameGridContent) Destroy(child.gameObject);
        
        avatarButtons.Clear();
        frameButtons.Clear();

        // 2. AVATARLARI DİZ (AvatarGroup Prefabı Kullanarak)
        if (GameManager.Instance.avatarList != null)
        {
            for (int i = 0; i < GameManager.Instance.avatarList.Count; i++)
            {
                int index = i; 
                GameObject btnObj = Instantiate(avatarGroupPrefab, avatarGridContent);
                
                // Prefabın ana Image bileşenine avatar resmini koyuyoruz
                ItemGroup itemGroup = btnObj.GetComponent<ItemGroup>();
                if (itemGroup != null) itemGroup.SetImageSprite(GameManager.Instance.avatarList[i]);
                
                // Tıklama Olayı
                btnObj.GetComponent<Button>().onClick.AddListener(() => {
                    OnAvatarSelected(index);
                });

                avatarButtons.Add(btnObj);
            }
        }

        // 3. ÇERÇEVELERİ DİZ (FrameGroup Prefabı Kullanarak)
        if (GameManager.Instance.frameList != null)
        {
            for (int i = 0; i < GameManager.Instance.frameList.Count; i++)
            {
                int index = i;
                GameObject btnObj = Instantiate(frameGroupPrefab, frameGridContent);
                
                // Prefabın ana Image bileşenine çerçeve resmini koyuyoruz
                ItemGroup itemGroup = btnObj.GetComponent<ItemGroup>();
                if (itemGroup != null) itemGroup.SetImageSprite(GameManager.Instance.frameList[i]);
                
                // Tıklama Olayı
                btnObj.GetComponent<Button>().onClick.AddListener(() => {
                    OnFrameSelected(index);
                });

                frameButtons.Add(btnObj);
            }
        }

        // 4. Listeler oluşur oluşmaz ışıkları yak
        HighlightSelectedItems();
    }

    // --- SEÇİM VE IŞIK MANTIĞI ---

    void OnAvatarSelected(int index)
    {
        selectedAvatarId = index;
        HighlightSelectedItems(); // Sadece ışıkları güncelle
    }

    void OnFrameSelected(int index)
    {
        selectedFrameId = index;
        HighlightSelectedItems(); // Sadece ışıkları güncelle
    }

    void HighlightSelectedItems()
    {
        // Avatar Butonlarını Gez
        for (int i = 0; i < avatarButtons.Count; i++)
        {
            // Prefabın içindeki "SelectionBorder" isimli objeyi bul
            ItemGroup border = avatarButtons[i].GetComponent<ItemGroup>();
            
            if (border != null)
            {
                // Eğer bu butonun sırası (i), seçili ID'ye eşitse -> AÇ, değilse -> KAPAT
                bool isSelected = (i == selectedAvatarId);
                border.SetSelectionBorder(isSelected);
            }
        }

        // Çerçeve Butonlarını Gez
        for (int i = 0; i < frameButtons.Count; i++)
        {
            // Prefabın içindeki "SelectionBorder" isimli objeyi bul
            ItemGroup border = frameButtons[i].GetComponent<ItemGroup>();
            
            if (border != null)
            {
                // Eğer bu butonun sırası (i), seçili ID'ye eşitse -> AÇ, değilse -> KAPAT
                bool isSelected = (i == selectedFrameId);
                border.SetSelectionBorder(isSelected);
            }
        }
    }

    // --- KAYDETME ---

    public void OnSaveButtonClicked()
    {
        string newName = nameInputField.text;
        
        // 1. PlayFab İsim Güncelleme
        if (PlayFabManager.Instance != null)
        {
            PlayFabManager.Instance.SubmitName(newName, 
            () => { Debug.Log("İsim PlayFab'da güncellendi"); }, 
            (error) => { Debug.LogError("İsim hatası: " + error); });
        }

        // 2. Yerel Veriyi Güncelle
        GameManager.Instance.playerData.username = newName;
        GameManager.Instance.playerData.avatarId = selectedAvatarId;
        GameManager.Instance.playerData.frameId = selectedFrameId;

        // 3. Kaydet
        GameManager.Instance.SaveGame();
        MainMenuManager.Instance.UpdateAllPanels();
        gameObject.SetActive(false);
    }
    
    public void OnCloseButtonClicked()
    {
        gameObject.SetActive(false); 
    }
}


---------------- FILE: ItemGroup.cs ----------------
using UnityEngine;
using UnityEngine.UI;

public class ItemGroup : MonoBehaviour
{
    public Image m_Image;
    public GameObject m_SelectionBorder;

    public void SetImageSprite(Sprite sprite)
    {
        m_Image.sprite = sprite;
    }

    public void SetSelectionBorder(bool status)
    {
        m_SelectionBorder.SetActive(status);
    }
}


---------------- FILE: OpenSettingsButton.cs ----------------
using UnityEngine;
using UnityEngine.UI;

[RequireComponent(typeof(Button))]
public class OpenSettingsButton : MonoBehaviour
{
    private void Start()
    {
        // 1. Üzerindeki Buton komponentini bul
        Button btn = GetComponent<Button>();

        if (btn != null)
        {
            // 2. Tıklanma olayına dinleyici ekle
            // (Öncekileri temizle ki çift tıklama olmasın)
            btn.onClick.RemoveAllListeners();
            btn.onClick.AddListener(OnClick);
        }
    }

    void OnClick()
    {
        // 3. SettingsManager'a ulaş ve paneli açtır
        if (SettingsManager.Instance != null)
        {
            SettingsManager.Instance.OpenSettings();
        }
        else
        {
            Debug.LogError("Hata: Sahnede SettingsManager bulunamadı!");
        }
    }
}


---------------- FILE: ObjectShake.cs ----------------
using UnityEngine;
using System.Collections;

public class ObjectShake : MonoBehaviour
{
    // Sarsıntıyı başlatmak için dışarıdan bu fonksiyonu çağıracağız
    public void Shake(float duration, float magnitude)
    {
        StopAllCoroutines(); // Varsa eski sarsıntıyı durdur ki üst üste binmesin
        StartCoroutine(ShakeRoutine(duration, magnitude));
    }

    IEnumerator ShakeRoutine(float duration, float magnitude)
    {
        Vector3 originalPos = transform.localPosition;
        float elapsed = 0.0f;

        while (elapsed < duration)
        {
            // Rastgele bir noktaya titret
            float x = Random.Range(-1f, 1f) * magnitude;
            float y = Random.Range(-1f, 1f) * magnitude;

            transform.localPosition = originalPos + new Vector3(x, y, 0);

            elapsed += Time.deltaTime;
            yield return null;
        }

        transform.localPosition = originalPos; // Yerine geri koy
    }
}


